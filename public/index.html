<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>å›½é‹å–¶ã‚²ãƒ¼ãƒ JAPAN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Google Fonts: Noto Sans JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Global Styles */
        body { font-family: 'Noto Sans JP', sans-serif; /* Changed font */ background: #f0f4f8; /* Lighter background */ color: #334e68; /* Darker text for better readability */ margin: 20px auto; max-width: 1024px; /* Slightly wider content area */ padding: 0 20px 40px 20px; line-height: 1.6; }
        h1 { text-align: center; color: #2c5282; /* Deeper blue for headings */ margin-bottom: 25px; font-size: 2.5em; font-weight: 700; }
        h2, h3 { color: #2c5282; margin-top: 40px; /* Increased margin-top for sections */ margin-bottom: 15px; font-weight: 700; border-bottom: 2px solid #d9e2ec; /* Subtle underline */ padding-bottom: 5px; }
        h2 i, h3 i { margin-right: 10px; color: #4a90e2; /* Accent color for icons */ }

        /* Form Elements */
        input[type="text"], input[type="number"], input[type="color"], select { padding: 8px 12px; /* Increased padding */ border: 1px solid #cbd5e1; border-radius: 6px; /* More rounded corners */ font-size: 15px; width: auto; min-width: 120px; margin-right: 10px; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
        input[type="text"]:focus, input[type="number"]:focus, select:focus { border-color: #4a90e2; /* Accent color on focus */ box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); outline: none; }
        input[type="color"] { padding: 4px; /* Adjust padding for color input */ height: 38px; /* Match height of other inputs */ vertical-align: middle; }

        button { background-color: #4a90e2; /* Primary blue button */ color: white; border: none; padding: 9px 18px; /* Increased padding */ border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color 0.25s ease, transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button:hover { background-color: #357ABD; /* Darker blue on hover */ transform: translateY(-1px); /* Slight lift on hover */ box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:active { transform: translateY(0); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        button:disabled { /* NEW: Style for disabled buttons */ background-color: #a0aec0; cursor: not-allowed; box-shadow: none; transform: none; }

        /* Map Section */
        #map { height: 600px; width: 100%; margin-top: 30px; border: 2px solid #d9e2ec; border-radius: 8px; /* More rounded map corners */ box-shadow: 0 5px 15px rgba(0,0,0,0.1); /* Stronger shadow */ }

        /* Card-like Sections */
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-top: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        #spyResult { background: #e0e7ff; /* Light blue for spy results */ border-color: #c3dafe; padding: 15px 20px; margin-top: 15px; max-width: 400px; /* Adjusted max-width */ }
        #newsList, #territoryRankingList, #chatLog, #activeWarsList, #ceasefireProposalsList, #whitePeaceProposalsList, #pendingFlightRequests, #establishedFlights { /* Unified styling for lists */ list-style: none; padding: 10px; max-height: 200px; /* Consistent height */ overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); /* Subtle inner shadow */ }
        #newsList li, #territoryRankingList li, #activeWarsList li, #ceasefireProposalsList li, #whitePeaceProposalsList li, #pendingFlightRequests li, #establishedFlights li { padding: 8px 5px; border-bottom: 1px dashed #e2e8f0; /* Dashed separator */ font-size: 14px; }
        #newsList li:last-child, #territoryRankingList li:last-child, #activeWarsList li:last-child, #ceasefireProposalsList li:last-child, #whitePeaceProposalsList li:last-child, #pendingFlightRequests li:last-child, #establishedFlights li:last-child { border-bottom: none; }
        #chatLog { height: 200px; padding: 15px; margin-bottom: 15px; }
        #chatLog p { margin: 5px 0; font-size: 14px; }
        .chat-time { color: #627d98; font-size: 0.85em; margin-right: 5px; }
        .chat-name { font-weight: bold; color: #2c5282; }

        #modeStatus, #invasionStatus { /* Combined styling for status messages */ padding: 10px 15px; font-weight: 700; color: #fff; background-color: #e03131; /* More vibrant red */ border-radius: 8px; margin-top: 20px; text-align: center; box-shadow: 0 2px 5px rgba(224, 49, 49, 0.3); }
        #invasionStatus { /* Specific styling for invasion status */ background-color: #dc3545; /* Red */ }

        /* Section Specific Styles */
        section { margin-bottom: 40px; }
        div { margin-bottom: 15px; /* Consistent spacing for form groups */ }
        div > label, div > input, div > select, div > button { vertical-align: middle; }

        #onlineUsers { background: #e6f0ff; border-color: #cce0ff; padding: 15px 20px; margin-top: 20px; }
        #onlineUsers h3 { color: #2b6cb0; margin-top: 0; margin-bottom: 10px; border-bottom: none; padding-bottom: 0; }
        #onlineUsersList { list-style: none; padding: 0; margin: 0; font-size: 14px; line-height: 1.8; display: flex; /* Flexbox for inline display */ flex-wrap: wrap; gap: 8px; /* Gap between items */ }
        #onlineUsersList li { background-color: #cce0ff; border-radius: 4px; padding: 5px 10px; color: #2c5282; font-weight: 500; border-bottom: none; /* Remove list item border */ }

        /* National Focus specific styles */
        .focus-list { list-style: none; padding: 0; }
        .focus-item { background-color: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px 20px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .focus-item h4 { margin-top: 0; margin-bottom: 8px; color: #2c5282; border-bottom: 1px dotted #e2e8f0; padding-bottom: 5px; font-size: 1.2em; }
        .focus-item p { font-size: 14px; color: #4a5568; margin-bottom: 8px; }
        .focus-item .cost { font-size: 13px; color: #718096; margin-bottom: 10px; }
        .focus-item button { float: right; margin-top: -10px; /* Adjust button position */ padding: 7px 14px; font-size: 0.9em; }
        #currentFocusStatus { background-color: #d1e7dd; /* Light green for active */ border: 1px solid #b3d1c1; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; color: #0f5132; box-shadow: 0 2px 5px rgba(15, 81, 50, 0.1); }
        #currentFocusStatus.no-focus { background-color: #f8d7da; /* Light red for no active focus */ border-color: #f5c2c7; color: #842029; box-shadow: 0 2px 5px rgba(132, 32, 41, 0.1); }
        #currentFocusStatus p { margin: 5px 0; }
        #currentFocusStatus strong { color: #0f5132; }
        #currentFocusStatus.no-focus strong { color: #842029; }

        /* Tutorial Box */
        #tutorialBox { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); /* Centered */ width: 90%; max-width: 550px; background: white; border: 2px solid #4a90e2; /* Accent border */ border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 9999; padding: 25px; text-align: center; }
        #tutorialBox #tutorialText { font-size: 1.1em; margin-bottom: 20px; color: #334e68; }
        #tutorialBox button { margin-top: 10px; float: none; /* Center button */ display: inline-block; }

        /* New CSS for glowing titles */
        .glowing-text { font-weight: bold; /* text-shadow will be applied dynamically via JS for the color */ /* Example: text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700; */ }

        /* War Management Specific Styles */
        .war-status-ongoing { color: #dc3545; font-weight: bold; }
        .war-status-declared { color: #ffc107; font-weight: bold; }
        .war-status-ceasefire { color: #17a2b8; font-weight: bold; }
        .war-status-ended { color: #6c757d; }
        .war-status-cancelled { color: #6c757d; }
        .war-status-whitepeaceproposed { color: #800080; font-weight: bold; } /* NEW: Purple for white peace */

        /* Peace Conference Modal */
        .modal { display: none; /* Hidden by default */ position: fixed; /* Stay in place */ z-index: 10000; /* Sit on top */ left: 0; top: 0; width: 100%; /* Full width */ height: 100%; /* Full height */ overflow: auto; /* Enable scroll if needed */ background-color: rgba(0,0,0,0.4); /* Black w/ opacity */ }

        .modal-content { background-color: #fefefe; margin: 5% auto; /* 5% from the top and centered */ padding: 30px; border: 1px solid #888; width: 90%; /* Could be more responsive */ max-width: 800px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }

        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px; }

        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }

        .peace-demand-section { margin-bottom: 20px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; background-color: #f8faff; }
        .peace-demand-section h4 { margin-top: 0; color: #2c5282; }
        .peace-demand-item { display: flex; align-items: center; margin-bottom: 10px; }
        .peace-demand-item label { flex: 1; margin-right: 10px; }
        .peace-demand-item input[type="number"] { flex: 2; max-width: 150px; }
        .peace-demand-item select { flex: 2; max-width: 150px; }
        .peace-demand-item span { flex: 1; text-align: right; font-weight: bold; }
        .peace-demand-item button { margin-left: 10px; padding: 5px 10px; font-size: 0.9em; }
        #peaceDemandsTerritories { width: 100%; height: 100px; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; box-sizing: border-box; }

        /* NEW: Flag Image Styles */
        .flag-icon { width: 20px; height: 14px; margin-right: 5px; vertical-align: middle; border: 1px solid #ccc; flex-shrink: 0; /* Prevent shrinking in flex containers */ }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            body { padding: 10px 15px 30px 15px; margin: 0 auto; }
            h1 { font-size: 2em; }
            h2, h3 { font-size: 1.5em; margin-top: 30px; }
            input[type="text"], input[type="number"], select, button { width: 100%; margin-bottom: 10px; margin-right: 0; }
            input[type="color"] { width: calc(100% - 10px); /* Adjust for padding */ }
            .card { padding: 15px; }
            #spyResult, #onlineUsers, #newsList, #chatLog { max-width: 100%; }
            .focus-item button { float: none; display: block; margin: 10px auto 0 auto; }
            .modal-content { margin: 10% auto; width: 95%; padding: 20px; }
            .peace-demand-item { flex-direction: column; align-items: flex-start; }
            .peace-demand-item label, .peace-demand-item input, .peace-demand-item select, .peace-demand-item span { width: 100%; margin-right: 0; margin-bottom: 5px; }
            .peace-demand-item button { margin-left: 0; margin-top: 10px; width: 100%; }
            #flagUrlInput { width: calc(100% - 120px) !important; /* Adjust for smaller screens */ }
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.8em; }
            h2, h3 { font-size: 1.3em; }
            #map { height: 400px; }
            #tutorialBox { padding: 15px; }
            #tutorialBox #tutorialText { font-size: 1em; }
        }
    </style>
</head>
<body>
    <h1><i class="fas fa-globe-asia"></i> å›½é‹å–¶ã‚²ãƒ¼ãƒ </h1>
    <section>
        <h2><i class="fas fa-book-open"></i> å›½é‹å–¶ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹</h2>
        <p>ã“ã®ã‚²ãƒ¼ãƒ ã§ã¯ã€ã‚ãªãŸãŒä¸€å›½ã®ãƒªãƒ¼ãƒ€ãƒ¼ã¨ãªã‚Šã€é ˜åœŸã®æ‹¡å¤§ãƒ»è»éšŠã®å¢—å¼·ãƒ»ãŠé‡‘ã®ç®¡ç†ãªã©ã‚’è¡Œã„ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒã‚¤ãƒ³ãƒˆã«ãã£ã¦ãƒ—ãƒ¬ã‚¤ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
        <ul>
            <li><strong>å›½ã®ç™»éŒ²:</strong> åœ°å›³ä¸Šã®ç°è‰²ã®ã€Œæœªæ‰€å±åœ°åŸŸã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ã¾ãšã¯è‡ªåˆ†ã®å›½ã‚’ç™»éŒ²ã—ã¾ã—ã‚‡ã†ï¼ˆæœ€åˆã®1ã¤ç›®ã¯ç„¡æ–™ã§ç™»éŒ²ã§ãã¾ã™ï¼‰</li>
            <li><strong>è‡ªåˆ†ã®å›½ã®æƒ…å ±ã‚’è¦‹ã‚‹:</strong> åœ°å›³ä¸Šã§è‡ªåˆ†ã®é ˜åœŸï¼ˆè‡ªåˆ†ã®è‰²ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å›½åãƒ»ãŠé‡‘ãƒ»è»éšŠã®æ•°ãªã©ã‚’ç¢ºèªã§ãã¾ã™ã€‚ä»–ã®å›½ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å›½ã®åå‰ã‚‚ã‚ã‹ã‚Šã¾ã™ã€‚</li>
            <li><strong>äººå£ã¨ãŠé‡‘:</strong> é ˜åœŸã‚’è³¼å…¥ã™ã‚‹ã¨äººå£ãŒå¢—ãˆï¼ˆ+1000ï¼‰ã€äººå£ã«å¿œã˜ã¦ãŠé‡‘ãŒè‡ªå‹•ã§å¢—ãˆã¦ã„ãã¾ã™ï¼ˆäººå£ Ã— 0.005å††ï¼‰ã€‚ãŸã ã—ã€é ˜åœŸã‚’å¥ªã‚ã‚Œã‚‹ã¨äººå£ãŒæ¸›ã£ã¦ã—ã¾ã„ã¾ã™ã€‚</li>
            <li><strong>è³‡æº (NEW):</strong> å„é ˜åœŸã¯ã€ŒçŸ³æ²¹ã€ã¨ã€Œé‰„ã€ã‚’ç”Ÿç”£ã—ã¾ã™ã€‚æ‰€æœ‰ã™ã‚‹é ˜åœŸã‹ã‚‰å®šæœŸçš„ã«è³‡æºãŒä¾›çµ¦ã•ã‚Œã¾ã™ã€‚</li>
            <li><strong>è»éšŠã®å¢—å¼·:</strong> ãŠé‡‘ã«åŠ ãˆã¦ã€çŸ³æ²¹ã¨é‰„ã‚’æ¶ˆè²»ã—ã¦æ­©å…µã€æˆ¦è»Šã€æ©Ÿæ¢°åŒ–æ­©å…µã€ç ²å…µã€çˆ†æ’ƒæ©Ÿã€ãƒŸã‚µã‚¤ãƒ«ã€æ ¸ãƒŸã‚µã‚¤ãƒ«ã‚’è³¼å…¥ã—ã€è»äº‹åŠ›ã‚’é«˜ã‚ã¾ã—ã‚‡ã†ã€‚</li>
            <li><strong>çˆ†æ’ƒæ©Ÿ:</strong> çˆ†æ’ƒæ©Ÿï¼ˆ90å††ã€çŸ³æ²¹ãƒ»é‰„æ¶ˆè²»ã‚ã‚Šï¼‰ã‚’è³¼å…¥ã—ã€æ•µé ˜åœŸã‚’çˆ†æ’ƒã—ã¦é˜²è¡›è»ã«æå®³ã‚’ä¸ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
            <li><strong>ãƒŸã‚µã‚¤ãƒ«:</strong> ãƒŸã‚µã‚¤ãƒ«ï¼ˆ10000å††ã€50çŸ³æ²¹ã€100é‰„æ¶ˆè²»ã‚ã‚Šï¼‰ã‚’è³¼å…¥ã—ã€æ•µé ˜åœŸã«ç™ºå°„ã™ã‚‹ã“ã¨ã§äººå£ã«ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã€é˜²è¡›è»ã‚’åŠå£Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
            <li><strong>æ ¸ãƒŸã‚µã‚¤ãƒ«:</strong> æ ¸ãƒŸã‚µã‚¤ãƒ«ï¼ˆ50000å††ã€500çŸ³æ²¹ã€1000é‰„æ¶ˆè²»ã‚ã‚Šï¼‰ã‚’è³¼å…¥ã—ã€æ•µé ˜åœŸã«ç™ºå°„ã™ã‚‹ã“ã¨ã§äººå£ã¨é˜²è¡›è»ã«å£Šæ»…çš„ãªãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã¾ã™ã€‚</li>
            <li><strong>ã‚¹ãƒ‘ã‚¤æ´»å‹•:</strong> ä»–å›½ã®å›½åã‚’å…¥åŠ›ã—ã¦ã‚¹ãƒ‘ã‚¤ã‚’é€ã‚‹ã¨ã€ãã®å›½ã®å…µåŠ›ã‚„ãŠé‡‘ã€ãã—ã¦çŸ³æ²¹ã‚„é‰„ã®æ‰€æŒé‡ã‚’èª¿æŸ»ã§ãã¾ã™ï¼ˆâ€»å¤±æ•—ã®å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ï¼‰ã€‚</li>
            <li><strong>è²¿æ˜“ï¼ˆæ´åŠ©ï¼‰:</strong> ä»–å›½ã«ãŠé‡‘ã‚„å…µåŠ›ã€ãã—ã¦çŸ³æ²¹ã‚„é‰„ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚å‹å¥½å›½ã¨ã®å”åŠ›ã‚„æ”¯æ´ã«æ´»ç”¨ã—ã¾ã—ã‚‡ã†ã€‚</li>
            <li>**é˜²è¡›:** é˜²è¡›åŠ›ã¯ã€ä¿æœ‰ã—ã¦ã„ã‚‹ç·è»å‚™ï¼ˆæ­©å…µã€æˆ¦è»Šã€æ©Ÿæ¢°åŒ–æ­©å…µã€ç ²å…µï¼‰ã‚’é ˜åœŸæ•°ã§å‰²ã£ãŸå€¤ã«åŸºã¥ã„ã¦è¨ˆç®—ã•ã‚Œã¾ã™ã€‚è»å‚™ã‚’å¢—å¼·ã—ã€é ˜åœŸã‚’æ‹¡å¤§ã™ã‚‹ã“ã¨ã§ã€å›½ã®é˜²è¡›åŠ›ãŒå‘ä¸Šã—ã¾ã™ã€‚</li>
            <li><strong>æ”»æ’ƒãƒ¢ãƒ¼ãƒ‰:</strong> æ•µå›½ã®é ˜åœŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ”»æ’ƒã‚’ä»•æ›ã‘ã¾ã™ã€‚å‹ã¤ã¨ãã®é ˜åœŸã‚’è‡ªåˆ†ã®ã‚‚ã®ã«ã§ãã¾ã™ï¼</li>
            <li><strong>çˆ†æ’ƒãƒ¢ãƒ¼ãƒ‰:</strong> çˆ†æ’ƒæ©Ÿã‚’æ¶ˆè²»ã—ã¦ã€æ•µå›½ã®é ˜åœŸã‚’çˆ†æ’ƒã—ã€é˜²è¡›éƒ¨éšŠã«æå®³ã‚’ä¸ãˆã¾ã™ã€‚</li>
            <li><strong>ãƒŸã‚µã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰:</strong> ãƒŸã‚µã‚¤ãƒ«ã‚’æ¶ˆè²»ã—ã¦ã€æ•µå›½ã®é ˜åœŸã«ç™ºå°„ã—ã€äººå£ã¨é˜²è¡›éƒ¨éšŠã«å¤§ããªæå®³ã‚’ä¸ãˆã¾ã™ã€‚</li>
            <li><strong>æ ¸ãƒŸã‚µã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰:</strong> æ ¸ãƒŸã‚µã‚¤ãƒ«ã‚’æ¶ˆè²»ã—ã¦ã€æ•µå›½ã®é ˜åœŸã«ç™ºå°„ã—ã€äººå£ã¨é˜²è¡›éƒ¨éšŠã«å£Šæ»…çš„ãªæå®³ã‚’ä¸ãˆã¾ã™ã€‚</li>
            <li><strong>æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹:</strong> æˆ¦é—˜ã‚„ã‚¹ãƒ‘ã‚¤æ´»å‹•ãªã©ã€ã‚²ãƒ¼ãƒ å†…ã§èµ·ããŸå‡ºæ¥äº‹ãŒé€Ÿå ±ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã¾ã‚ã«ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ã€‚</li>
        </ul>
        <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é–‹å§‹ãƒœã‚¿ãƒ³ -->
        <button id="startTutorialBtn" onclick="startTutorial()" style=" display: block; margin: 20px auto; padding: 15px 30px; font-size: 20px; font-weight: bold; background-color: #10b981; color: white; border: none; border-radius: 10px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); cursor: pointer; transition: background-color 0.3s, transform 0.1s; ">ğŸ§­ ã¯ã˜ã‚ã¦ã®æ–¹ã¸ï¼šãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å§‹ã‚ã‚‹</button>

        <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="tutorialBox" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); width:80%; max-width:500px; background:white; border:2px solid #2563eb; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:9999; padding:20px;">
            <div id="tutorialText" style="font-size:16px; margin-bottom:15px;"></div>
            <button onclick="nextTutorialStep()" style="float:right;">â–¶ æ¬¡ã¸</button>
        </div>

    </section>
    <div class="card">
        <h3><i class="fas fa-book-open"></i> å›½ã®ç™»éŒ²</h3>
        ç™»éŒ²ã™ã‚‹å›½å: <input id="nationNameInput" type="text" placeholder="ã‚ãªãŸã®å›½ã®åå‰" />
        <button onclick="startRegisterNation()"><i class="fas fa-plus-circle"></i> å›½ã‚’ç™»éŒ²</button>
    </div>

    <div class="card">
        <h3><i class="fas fa-hammer"></i> è»éšŠå¢—å¼·</h3>
        ç¨®é¡: <select id="unitType">
        <option value="infantry">æ­©å…µ (<span id="infantryCost"></span>å††, <span id="infantryOilCost"></span>çŸ³æ²¹, <span id="infantryIronCost"></span>é‰„)</option>
        <option value="tank">æˆ¦è»Š (<span id="tankCost"></span>å††, <span id="tankOilCost"></span>çŸ³æ²¹, <span id="tankIronCost"></span>é‰„)</option>
        <option value="mechanizedInfantry">æ©Ÿæ¢°åŒ–æ­©å…µ (<span id="mechanizedInfantryCost"></span>å††, <span id="mechanizedInfantryOilCost"></span>çŸ³æ²¹, <span id="mechanizedInfantryIronCost"></span>é‰„)</option>
        <option value="artillery">ç ²å…µ (<span id="artilleryCost"></span>å††, <span id="artilleryOilCost"></span>çŸ³æ²¹, <span id="artilleryIronCost"></span>é‰„)</option>
        <option value="bomber">çˆ†æ’ƒæ©Ÿ (<span id="bomberCost"></span>å††, <span id="bomberOilCost"></span>çŸ³æ²¹, <span id="bomberIronCost"></span>é‰„)</option>
        <option value="missile">ãƒŸã‚µã‚¤ãƒ« (<span id="missileCost"></span>å††, <span id="missileOilCost"></span>çŸ³æ²¹, <span id="missileIronCost"></span>é‰„)</option>
        <option value="nuclearMissile">æ ¸ãƒŸã‚µã‚¤ãƒ« (<span id="nuclearMissileCost"></span>å††, <span id="nuclearMissileOilCost"></span>çŸ³æ²¹, <span id="nuclearMissileIronCost"></span>é‰„)</option>
    </select>
        æ•°é‡: <input type="number" id="unitAmount" value="1" min="1" />
        <button onclick="reinforce()"><i class="fas fa-cart-plus"></i> å¢—å¼·</button>
    </div>

    <!-- NEW: Infrastructure Building Section -->
    <div class="card">
        <h3><i class="fas fa-building"></i> ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»è¦³å…‰æ–½è¨­å»ºè¨­</h3>
        ç¨®é¡: <select id="infrastructureType">
        <option value="railway">é‰„é“ (<span id="railwayCost"></span>å††, <span id="railwayIronCost"></span>é‰„, <span id="railwayOilCost"></span>çŸ³æ²¹)</option>
        <option value="shinkansen">æ–°å¹¹ç·š (<span id="shinkansenCost"></span>å††, <span id="shinkansenIronCost"></span>é‰„, <span id="shinkansenOilCost"></span>çŸ³æ²¹)</option>
        <option value="airport">ç©ºæ¸¯ (<span id="airportCost"></span>å††, <span id="airportIronCost"></span>é‰„, <span id="airportOilCost"></span>çŸ³æ²¹)</option>
        <option value="tourismFacility">è¦³å…‰æ–½è¨­ (<span id="tourismFacilityCost"></span>å††, <span id="tourismFacilityIronCost"></span>é‰„, <span id="tourismFacilityOilCost"></span>çŸ³æ²¹)</option>
    </select>
        æ•°é‡: <input type="number" id="infrastructureAmount" value="1" min="1" />
        <button onclick="buildInfrastructure()"><i class="fas fa-plus-square"></i> å»ºè¨­</button>
    </div>

    <!-- NEW: Flight Management Section -->
    <div class="card">
        <h3><i class="fas fa-plane"></i> é£›è¡Œæ©Ÿä¾¿ç®¡ç†</h3>
        <div>
            é£›è¡Œæ©Ÿä¾¿ç”³è«‹å…ˆå›½å: <input type="text" id="flightTargetNationName" placeholder="ç”³è«‹å…ˆã®å›½å" />
            <button onclick="requestFlight()"><i class="fas fa-paper-plane"></i> é£›è¡Œæ©Ÿä¾¿ç”³è«‹</button>
        </div>
        <div>
            <h4><i class="fas fa-inbox"></i> ã‚ãªãŸã¸ã®é£›è¡Œæ©Ÿä¾¿ç”³è«‹</h4>
            <ul id="pendingFlightRequests" class="card"></ul>
        </div>
        <div>
            <h4><i class="fas fa-route"></i> ç¾åœ¨ã®é£›è¡Œæ©Ÿä¾¿</h4>
            <ul id="establishedFlights" class="card"></ul>
        </div>
    </div>

    <div class="card">
        <h3><i class="fas fa-user-secret"></i> ã‚¹ãƒ‘ã‚¤æ´»å‹•</h3>
        ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå›½å: <input type="text" id="spyTargetNation" placeholder="ã‚¹ãƒ‘ã‚¤å¯¾è±¡ã®å›½å" />
        <button onclick="spy()"><i class="fas fa-eye"></i> ã‚¹ãƒ‘ã‚¤ã™ã‚‹</button>
        <div id="spyResult" class="card" style="margin-top:10px; font-weight:bold;"></div>
    </div>

    <!-- NEW: Sabotage Section -->
    <div class="card">
        <h3><i class="fas fa-user-ninja"></i> ç ´å£Šå·¥ä½œ (Sabotage)</h3>
        <p>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå›½ã®å…µåŠ›ã€è³‡é‡‘ã€è³‡æºã€äººå£ã«æå®³ã‚’ä¸ãˆã‚‹æ”»æ’ƒç‰ˆã‚¹ãƒ‘ã‚¤æ´»å‹•ã§ã™ã€‚</p>
        <p>ã‚³ã‚¹ãƒˆ: <span id="sabotageCost"></span>å†† (å¤±æ•—æ™‚: è¿½åŠ ã§<span id="sabotageFailureCost"></span>å††)</p>
        ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå›½å: <input type="text" id="sabotageTargetNation" placeholder="ç ´å£Šå·¥ä½œå¯¾è±¡ã®å›½å" />
        <button onclick="sabotage()"><i class="fas fa-bomb"></i> ç ´å£Šå·¥ä½œã‚’å®Ÿè¡Œ</button>
    </div>

    <div class="card">
        <h3><i class="fas fa-exchange-alt"></i> è²¿æ˜“</h3>
        ç›¸æ‰‹å›½å: <input type="text" id="targetNationName" placeholder="ç›¸æ‰‹ã®å›½å" />
        è³‡æº: <select id="resourceType">
        <option value="money">ãŠé‡‘</option>
        <option value="infantry">æ­©å…µ</option>
        <option value="tank">æˆ¦è»Š</option>
        <option value="mechanizedInfantry">æ©Ÿæ¢°åŒ–æ­©å…µ</option>
        <option value="artillery">ç ²å…µ</option>
        <option value="bomber">çˆ†æ’ƒæ©Ÿ</option>
        <option value="missile">ãƒŸã‚µã‚¤ãƒ«</option>
        <option value="nuclearMissile">æ ¸ãƒŸã‚µã‚¤ãƒ«</option>
        <option value="oil">çŸ³æ²¹</option>
        <option value="iron">é‰„</option>
    </select>
        æ•°é‡: <input type="number" id="resourceAmount" min="1" value="10" />
        <button onclick="sendResourcesByName()"><i class="fas fa-paper-plane"></i> é€ã‚‹</button>
    </div>

    <div class="card">
        <h3><i class="fas fa-handshake"></i> é ˜åœŸè­²æ¸¡ãƒ¢ãƒ¼ãƒ‰</h3>
        è­²æ¸¡å…ˆå›½å: <input type="text" id="transferNationName" placeholder="è­²æ¸¡å…ˆã®å›½å" />
        <button onclick="startTransferMode()"><i class="fas fa-share-square"></i> è­²æ¸¡ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
        <button onclick="endTransferMode()"><i class="fas fa-times-circle"></i> è­²æ¸¡ãƒ¢ãƒ¼ãƒ‰çµ‚äº†</button>
        <p>è­²æ¸¡ã—ãŸã„é ˜åœŸã‚’åœ°å›³ã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div class="card">
        <h3><i class="fas fa-users-cog"></i> åŒç›Ÿç®¡ç†</h3>
        <div>
            åŒç›Ÿç”³è«‹å…ˆå›½å: <input type="text" id="allianceTargetNationName" placeholder="ç”³è«‹å…ˆã®å›½å" />
            <button onclick="requestAlliance()"><i class="fas fa-user-plus"></i> åŒç›Ÿç”³è«‹</button>
        </div>
        <div>
            <h4><i class="fas fa-inbox"></i> ã‚ãªãŸã¸ã®åŒç›Ÿç”³è«‹</h4>
            <ul id="pendingAllianceRequests" class="card"></ul>
        </div>
        <div>
            <h4><i class="fas fa-handshake-alt"></i> ç¾åœ¨ã®åŒç›Ÿå›½</h4>
            <ul id="currentAlliances" class="card"></ul>
        </div>
    </div>

    <div class="card">
        <h3><i class="fas fa-edit"></i> å›½ã®æƒ…å ±å¤‰æ›´</h3>
        <div>
            æ–°ã—ã„å›½å: <input id="newNationNameInput" type="text" placeholder="æ–°ã—ã„å›½å" />
            æ–°ã—ã„è‰²: <input id="newNationColorInput" type="color" value="#4a90e2" />
            <button onclick="changeNationInfo()"><i class="fas fa-save"></i> å¤‰æ›´ã™ã‚‹</button>
        </div>
    </div>

    <!-- NEW: Flag Editor Section -->
    <div class="card">
        <h3><i class="fas fa-flag"></i> å›½æ——ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</h3>
        <div>
            <label for="flagUrlInput">å›½æ——URL:</label>
            <input type="text" id="flagUrlInput" placeholder="ç”»åƒURL (ä¾‹: https://example.com/flag.png)" style="width: calc(100% - 120px);" />
            <button onclick="updateFlagFromUrl()">URLã§æ›´æ–°</button>
        </div>
        <div style="margin-top: 10px;">
            <input type="file" id="flagFileInput" accept="image/*" style="display: none;">
            <button onclick="document.getElementById('flagFileInput').click()"><i class="fas fa-upload"></i> ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰é¸æŠ</button>
            <canvas id="flagCanvas" style="display:none;"></canvas>
        </div>
        <div id="currentFlagDisplay" style="margin-top: 10px; text-align: center;">
            <p>ç¾åœ¨ã®å›½æ——:</p>
            <img id="currentFlagImage" src="" alt="ç¾åœ¨ã®å›½æ——" class="flag-icon" style="max-width: 300px; max-height: 210px; border: 1px solid #ccc; display: none;" />
            <p id="noFlagMessage" style="display: block;">å›½æ——ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
        </div>
    </div>

    <!-- NEW: Title Management Section -->
    <div class="card">
        <h2><i class="fas fa-crown"></i> ç§°å·ç®¡ç†</h2>
        <div>
            <p>ç¾åœ¨ã®è¡¨ç¤ºç§°å·: <span id="currentDisplayTitle">ãªã—</span></p>
            <p>æ‰€æœ‰ç§°å·ã‹ã‚‰é¸æŠ:</p>
            <select id="acquiredTitlesSelect">
                <!-- Options will be populated by JS -->
            </select>
            <button onclick="selectDisplayTitle()"><i class="fas fa-check-circle"></i> ã“ã®ç§°å·ã‚’è¡¨ç¤º</button>
            <button onclick="grantTestTitle()"><i class="fas fa-gift"></i> ãƒ†ã‚¹ãƒˆç§°å·ä»˜ä¸</button>
        </div>
    </div>

    <div class="card">
        <h3><i class="fas fa-bomb"></i> çˆ†æ’ƒãƒ¢ãƒ¼ãƒ‰</h3>
        çˆ†æ’ƒæ©Ÿæ•°: <input type="number" id="bomberCount" value="1" min="1" max="100">
        <button id="startBombardModeBtn" onclick="startBombardMode()"><i class="fas fa-plane-departure"></i> çˆ†æ’ƒãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
        <button onclick="endBombardMode()"><i class="fas fa-times-circle"></i> çˆ†æ’ƒãƒ¢ãƒ¼ãƒ‰çµ‚äº†</button>
        <p>çˆ†æ’ƒã—ãŸã„é ˜åœŸã‚’åœ°å›³ã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
    </div>
    <div class="card">
        <h3><i class="fas fa-rocket"></i> ãƒŸã‚µã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰</h3>
        ãƒŸã‚µã‚¤ãƒ«ç™ºå°„æ•°: <input type="number" id="missileCount" value="1" min="1" max="100">
        <button id="startMissileModeBtn" onclick="startMissileMode()"><i class="fas fa-crosshairs"></i> ãƒŸã‚µã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
        <button onclick="endMissileMode()"><i class="fas fa-times-circle"></i> ãƒŸã‚µã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰çµ‚äº†</button>
        <p>ãƒŸã‚µã‚¤ãƒ«ã‚’ç™ºå°„ã—ãŸã„æ•µé ˜åœŸã‚’åœ°å›³ã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
    </div>

    <!-- NEW: Nuclear Missile Mode -->
    <div class="card">
        <h3><i class="fas fa-radiation"></i> æ ¸ãƒŸã‚µã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰</h3>
        æ ¸ãƒŸã‚µã‚¤ãƒ«ç™ºå°„æ•°: <input type="number" id="nuclearMissileCount" value="1" min="1" max="5">
        <button id="startNuclearMissileModeBtn" onclick="startNuclearMissileMode()"><i class="fas fa-biohazard"></i> æ ¸ãƒŸã‚µã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
        <button onclick="endNuclearMissileMode()"><i class="fas fa-times-circle"></i> æ ¸ãƒŸã‚µã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰çµ‚äº†</button>
        <p>æ ¸ãƒŸã‚µã‚¤ãƒ«ã‚’ç™ºå°„ã—ãŸã„æ•µé ˜åœŸã‚’åœ°å›³ã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
    </div>

    <div class="card">
        <h3><i class="fas fa-fist-raised"></i> æ”»æ’ƒå®Ÿè¡Œ</h3>
        æ”»æ’ƒæ­©å…µæ•°: <input type="number" id="attackInfantry" value="10" max="200" min="20">
        æ”»æ’ƒæˆ¦è»Šæ•°: <input type="number" id="attackTank" value="5" max="70" min="0">
        æ”»æ’ƒæ©Ÿæ¢°åŒ–æ­©å…µæ•°: <input type="number" id="attackMechInf" value="5" max="130" min="0">
        æ”»æ’ƒç ²å…µæ•°: <input type="number" id="attackArtillery" value="0" max="100" min="0">
        <button id="startAttackModeBtn" onclick="startAttackMode()"><i class="fas fa-gavel"></i> æ”»æ’ƒãƒ¢ãƒ¼ãƒ‰é–‹å§‹</button>
        <p>ç›¸æ‰‹é ˜åœŸã‚’åœ°å›³ã§ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ”»æ’ƒé–‹å§‹</p>
    </div>

    <!-- NEW: Rebellion Section -->
    <div class="card">
        <h3><i class="fas fa-republican"></i> åä¹± (Rebellion)</h3>
        <p>é ˜åœŸã‚’æ‰€æœ‰ã—ã¦ã„ãªã„å ´åˆã€ä»–å›½ã®é ˜åœŸã§åä¹±ã‚’èµ·ã“ã—ã€æ–°ãŸãªå›½ã‚’å»ºå›½ã§ãã¾ã™ã€‚</p>
        <p><strong>æ³¨æ„:</strong> åä¹±ã¯1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¤ãæœ€å¤§<span id="maxRebellionsCount"></span>å›ã¾ã§å¯èƒ½ã§ã™ã€‚</p>
        åä¹±ã‚’èµ·ã“ã™é ˜åœŸå: <input type="text" id="rebellionTargetCountryName" placeholder="åä¹±ã‚’èµ·ã“ã™é ˜åœŸå" />
        <button onclick="attemptRebellion()"><i class="fas fa-hand-sparkles"></i> åä¹±ã‚’èµ·ã“ã™</button>
    </div>

    <!-- NEW: War Management Section -->
    <div class="card">
        <h2><i class="fas fa-bell"></i> æˆ¦äº‰ç®¡ç†</h2>
        <div>
            <h3><i class="fas fa-flag-checkered"></i> å®£æˆ¦å¸ƒå‘Š</h3>
            å®£æˆ¦å¸ƒå‘Šå¯¾è±¡å›½å: <input type="text" id="warTargetNationName" placeholder="å®£æˆ¦å¸ƒå‘Šã™ã‚‹å›½å" />
            <button onclick="declareWar()"><i class="fas fa-exclamation-triangle"></i> å®£æˆ¦å¸ƒå‘Š</button>
        </div>
        <div>
            <h3><i class="fas fa-scroll"></i> ç¾åœ¨ã®æˆ¦äº‰</h3>
            <ul id="activeWarsList" class="card"></ul>
        </div>
        <div>
            <h3><i class="fas fa-handshake-alt-slash"></i> åœæˆ¦ææ¡ˆ</h3>
            <ul id="ceasefireProposalsList" class="card"></ul>
        </div>
        <!-- NEW: White Peace Proposals Section -->
        <div>
            <h3><i class="fas fa-peace"></i> ç™½ç´™è¬›å’Œææ¡ˆ</h3>
            <ul id="whitePeaceProposalsList" class="card"></ul>
        </div>
    </div>

    <div class="card">
        <h2><i class="fas fa-comments"></i> å…¨ä½“ãƒãƒ£ãƒƒãƒˆ</h2>
        <div id="chatLog"></div>
        <div>
            <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." style="width: calc(100% - 90px);" onkeydown="if(event.key === 'Enter') sendChatMessage();">
            <button onclick="sendChatMessage()" style="width: 80px;"><i class="fas fa-paper-plane"></i> é€ä¿¡</button>
        </div>
    </div>

    <div class="card">
        <h3><i class="fas fa-users"></i> ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</h3>
        <p style="font-size: 12px; color: #666;">â€»30ç§’ä»¥å†…ã«æ´»å‹•ãŒã‚ã£ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        <ul id="onlineUsersList">
            <li>èª­ã¿è¾¼ã¿ä¸­...</li>
        </ul>
    </div>
    <img src="https://www.cloudsemi.com/test/so/douga/so1png/sc1ja_001-09.png" height="400" alt="è³‡æºåˆ†å¸ƒ" style="display: block; max-width: 100%; height: auto; margin: 20px auto; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.08);">

    <div class="card">
        <h2><i class="fas fa-newspaper"></i> æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹</h2>
        <ul id="newsList"></ul>
    </div>

    <div class="card">
        <h2><i class="fas fa-trophy"></i> é ˜åœŸæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        <ul id="territoryRankingList">
            <li>èª­ã¿è¾¼ã¿ä¸­...</li>
        </ul>
    </div>

    <div id="modeStatus" style="padding: 5px; font-weight: bold; color: white; background-color: darkred; display: none;">
        ãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œä¸­ï¼å¯¾è±¡ã®é ˜åœŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
    </div>

    <!-- NEW: Invasion Status Display -->
    <div id="invasionStatus" style="padding: 5px; font-weight: bold; color: white; background-color: darkred; display: none;">
        ç¾åœ¨ã€æ”»æ’ƒãŒé€²è¡Œä¸­ã§ã™ã€‚å®Œäº†ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚
    </div>

    <div id="map"></div>

    <!-- NEW: National Focus Section -->
    <div class="card">
        <h2><i class="fas fa-bullseye"></i> å›½å®¶æ–¹é‡</h2>
        <div id="currentFocusStatus" class="no-focus">
            <p><strong>ç¾åœ¨ã®å›½å®¶æ–¹é‡:</strong> <span id="focusName">ãªã—</span></p>
            <p><span id="focusDescription">å›½å®¶æ–¹é‡ã‚’é¸æŠã—ã¦ã€å›½ã‚’å¼·åŒ–ã—ã¾ã—ã‚‡ã†ã€‚</span></p>
            <p id="focusProgress">æ®‹ã‚Šã‚¿ãƒ¼ãƒ³: <span id="focusTurnsRemaining"></span></p>
            <button id="resetFocusBtn" onclick="resetFocus()" style="display: none;"><i class="fas fa-redo-alt"></i> å›½å®¶æ–¹é‡ã‚’ãƒªã‚»ãƒƒãƒˆ (ãƒ†ã‚¹ãƒˆç”¨)</button>
        </div>

        <h3><i class="fas fa-list-alt"></i> åˆ©ç”¨å¯èƒ½ãªå›½å®¶æ–¹é‡</h3>
        <ul id="availableFocuses" class="focus-list">
            <li>å›½å®¶æ–¹é‡ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
        </ul>
    </div>

    <!-- Peace Conference Modal -->
    <div id="peaceConferenceModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closePeaceConferenceModal()">&times;</span>
            <h2><i class="fas fa-gavel"></i> è¬›å’Œä¼šè­°</h2>
            <p><strong>æˆ¦äº‰ID:</strong> <span id="pcWarId"></span></p>
            <p><strong>å‹è€…:</strong> <span id="pcWinnerNation"></span></p>
            <p><strong>æ•—è€…:</strong> <span id="pcLoserNation"></span></p>
            <p><strong>åˆ©ç”¨å¯èƒ½ãªæˆ¦å‹ç‚¹:</strong> <span id="pcAvailableWarPoints"></span></p>
            <p><strong>è¦æ±‚ã‚³ã‚¹ãƒˆ:</b> <span id="pcDemandsCost">0</span></p>

            <div class="peace-demand-section">
                <h4><i class="fas fa-coins"></i> è³ å„Ÿé‡‘ (ãŠé‡‘ãƒ»è³‡æº)</h4>
                <div class="peace-demand-item">
                    <label for="pcMoney">ãŠé‡‘ (<span id="pcLoserMoney"></span>å††ã¾ã§)</label>
                    <input type="number" id="pcMoney" min="0" value="0" oninput="calculatePeaceDemandsCost()">
                    <span>ã‚³ã‚¹ãƒˆ: <span id="pcMoneyCost">0</span></span>
                </div>
                <div class="peace-demand-item">
                    <label for="pcOil">çŸ³æ²¹ (<span id="pcLoserOil"></span>å€‹ã¾ã§)</label>
                    <input type="number" id="pcOil" min="0" value="0" oninput="calculatePeaceDemandsCost()">
                    <span>ã‚³ã‚¹ãƒˆ: <span id="pcOilCost">0</span></span>
                </div>
                <div class="peace-demand-item">
                    <label for="pcIron">é‰„ (<span id="pcLoserIron"></span>å€‹ã¾ã§)</label>
                    <input type="number" id="pcIron" min="0" value="0" oninput="calculatePeaceDemandsCost()">
                    <span>ã‚³ã‚¹ãƒˆ: <span id="pcIronCost">0</span></span>
                </div>
            </div>

            <div class="peace-demand-section">
                <h4><i class="fas fa-users"></i> è»å‚™</h4>
                <div class="peace-demand-item">
                    <label for="pcInfantry">æ­©å…µ (<span id="pcLoserInfantry"></span>ä½“ã¾ã§)</label>
                    <input type="number" id="pcInfantry" min="0" value="0" oninput="calculatePeaceDemandsCost()">
                    <span>ã‚³ã‚¹ãƒˆ: <span id="pcInfantryCost">0</span></span>
                </div>
                <div class="peace-demand-item">
                    <label for="pcTank">æˆ¦è»Š (<span id="pcLoserTank"></span>å°ã¾ã§)</label>
                    <input type="number" id="pcTank" min="0" value="0" oninput="calculatePeaceDemandsCost()">
                    <span>ã‚³ã‚¹ãƒˆ: <span id="pcTankCost">0</span></span>
                </div>
                <div class="peace-demand-item">
                    <label for="pcMechanizedInfantry">æ©Ÿæ¢°åŒ–æ­©å…µ (<span id="pcLoserMechanizedInfantry"></span>ä½“ã¾ã§)</label>
                    <input type="number" id="pcMechanizedInfantry" min="0" value="0" oninput="calculatePeaceDemandsCost()">
                    <span>ã‚³ã‚¹ãƒˆ: <span id="pcMechanizedInfantryCost">0</span></span>
                </div>
                <div class="peace-demand-item">
                    <label for="pcArtillery">ç ²å…µ (<span id="pcLoserArtillery"></span>ä½“ã¾ã§)</label>
                    <input type="number" id="pcArtillery" min="0" value="0" oninput="calculatePeaceDemandsCost()">
                    <span>ã‚³ã‚¹ãƒˆ: <span id="pcArtilleryCost">0</span></span>
                </div>
                <div class="peace-demand-item">
                    <label for="pcBomber">çˆ†æ’ƒæ©Ÿ (<span id="pcLoserBomber"></span>æ©Ÿã¾ã§)</label>
                    <input type="number" id="pcBomber" min="0" value="0" oninput="calculatePeaceDemandsCost()">
                    <span>ã‚³ã‚¹ãƒˆ: <span id="pcBomberCost">0</span></span>
                </div>
                <div class="peace-demand-item">
                    <label for="pcMissile">ãƒŸã‚µã‚¤ãƒ« (<span id="pcLoserMissile"></span>æ©Ÿã¾ã§)</label>
                    <input type="number" id="pcMissile" min="0" value="0" oninput="calculatePeaceDemandsCost()">
                    <span>ã‚³ã‚¹ãƒˆ: <span id="pcMissileCost">0</span></span>
                </div>
                <div class="peace-demand-item">
                    <label for="pcNuclearMissile">æ ¸ãƒŸã‚µã‚¤ãƒ« (<span id="pcLoserNuclearMissile"></span>æ©Ÿã¾ã§)</label>
                    <input type="number" id="pcNuclearMissile" min="0" value="0" oninput="calculatePeaceDemandsCost()">
                    <span>ã‚³ã‚¹ãƒˆ: <span id="pcNuclearMissileCost">0</span></span>
                </div>
            </div>

            <div class="peace-demand-section">
                <h4><i class="fas fa-map"></i> é ˜åœŸ</h4>
                <p>è¦æ±‚ã™ã‚‹é ˜åœŸã‚’é¸æŠã—ã¦ãã ã•ã„ (è¤‡æ•°é¸æŠå¯)ã€‚</p>
                <select id="peaceDemandsTerritories" multiple size="5" onchange="calculatePeaceDemandsCost()">
                    <!-- Options will be populated by JS -->
                </select>
                <span>ã‚³ã‚¹ãƒˆ: <span id="pcTerritoryCost">0</span></span>
            </div>

            <button onclick="makePeaceDemands()"><i class="fas fa-check-circle"></i> è¦æ±‚ã‚’ç¢ºå®šã—è¬›å’Œã™ã‚‹</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==========================================================
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ JavaScript ã®ã‚³ãƒ¼ãƒ‰
        // ==========================================================

        let nationalFocusDefinitionsClient = {};
        let missileMode = false;
        let nuclearMissileMode = false;
        let isRegisteringNation = false;
        let attackMode = false;
        let bombardMode = false;
        let transferMode = false;
        let currentUserIp = null; // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›´
        let gameConstants = {};

        // Peace Conference Costs (will be populated from gameConstants)
        let PEACE_COST_MONEY_PER_1000_CLIENT;
        let PEACE_COST_INFANTRY_CLIENT;
        let PEACE_COST_TANK_CLIENT;
        let PEACE_COST_MECHANIZED_INFANTRY_CLIENT;
        let PEACE_COST_BOMBER_CLIENT;
        let PEACE_COST_MISSILE_CLIENT;
        let PEACE_COST_NUCLEAR_MISSILE_CLIENT;
        let PEACE_COST_ARTILLERY_CLIENT;
        let PEACE_COST_OIL_PER_10_CLIENT;
        let PEACE_COST_IRON_PER_10_CLIENT;
        let PEACE_COST_TERRITORY_CLIENT;

        let SABOTAGE_COST_CLIENT;
        let SABOTAGE_FAILURE_COST_CLIENT;

        let RAILWAY_COST_CLIENT;
        let RAILWAY_IRON_COST_CLIENT;
        let RAILWAY_OIL_COST_CLIENT;

        let SHINKANSEN_COST_CLIENT;
        let SHINKANSEN_IRON_COST_CLIENT;
        let SHINKANSEN_OIL_COST_CLIENT;

        let AIRPORT_COST_CLIENT;
        let AIRPORT_IRON_COST_CLIENT;
        let AIRPORT_OIL_COST_CLIENT;

        let TOURISM_FACILITY_COST_CLIENT;
        let TOURISM_FACILITY_IRON_COST_CLIENT;
        let TOURISM_FACILITY_OIL_COST_CLIENT;

        let BASE_TERRITORY_COST_CLIENT;
        let MAX_REBELLIONS_CLIENT;

        const WAR_STATUS_WHITE_PEACE_PROPOSED = "WhitePeaceProposed";

        var map = L.map('map').setView([35.6895, 139.6917], 5);
        L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
            maxZoom: 18,
            subdomains: ['a', 'b', 'c', 'd'],
            attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a> ' + '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);

        let nations = [];
        let geojsonLayer;
        let titleDefinitions = {};
        let nationNameToIpMap = {}; // nationName -> IPã‚¢ãƒ‰ãƒ¬ã‚¹
        let currentPeaceConferenceWar = null;

        // ==========================================================
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        // ==========================================================

        // Fetch APIã‚’ãƒ©ãƒƒãƒ—ã—ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å…±é€šåŒ–
        async function fetchData(url, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) {
                options.body = JSON.stringify(body);
            }
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `API Request Failed: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch {
                        errorMessage = errorText; // JSONã§ãªã‘ã‚Œã°ç”Ÿãƒ†ã‚­ã‚¹ãƒˆ
                    }
                    throw new Error(errorMessage);
                }
                return response.json();
            } catch (error) {
                console.error(`Error requesting ${url}:`, error);
                throw error; // UIã§è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
            }
        }

        // ã‚³ã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        // updateCostDisplaysé–¢æ•°ã¯å‰ã®å¿œç­”ã§æä¾›æ¸ˆã¿ (ãã®ã¾ã¾ä½¿ç”¨)
        function updateCostDisplays() {
            if (!gameConstants) return;
            document.getElementById('infantryCost').textContent = gameConstants.INFANTRY_COST;
            document.getElementById('infantryOilCost').textContent = gameConstants.INFANTRY_OIL_COST;
            document.getElementById('infantryIronCost').textContent = gameConstants.INFANTRY_IRON_COST;
            document.getElementById('tankCost').textContent = gameConstants.TANK_COST;
            document.getElementById('tankOilCost').textContent = gameConstants.TANK_OIL_COST;
            document.getElementById('tankIronCost').textContent = gameConstants.TANK_IRON_COST;
            document.getElementById('mechanizedInfantryCost').textContent = gameConstants.MECHANIZED_INFANTRY_COST;
            document.getElementById('mechanizedInfantryOilCost').textContent = gameConstants.MECHANIZED_INFANTRY_OIL_COST;
            document.getElementById('mechanizedInfantryIronCost').textContent = gameConstants.MECHANIZED_INFANTRY_IRON_COST;
            document.getElementById('artilleryCost').textContent = gameConstants.ARTILLERY_COST;
            document.getElementById('artilleryOilCost').textContent = gameConstants.ARTILLERY_OIL_COST;
            document.getElementById('artilleryIronCost').textContent = gameConstants.ARTILLERY_IRON_COST;
            document.getElementById('bomberCost').textContent = gameConstants.BOMBER_COST;
            document.getElementById('bomberOilCost').textContent = gameConstants.BOMBER_OIL_COST;
            document.getElementById('bomberIronCost').textContent = gameConstants.BOMBER_IRON_COST;
            document.getElementById('missileCost').textContent = gameConstants.MISSILE_COST;
            document.getElementById('missileOilCost').textContent = gameConstants.MISSILE_OIL_COST;
            document.getElementById('missileIronCost').textContent = gameConstants.MISSILE_IRON_COST;
            document.getElementById('nuclearMissileCost').textContent = gameConstants.NUCLEAR_MISSILE_COST;
            document.getElementById('nuclearMissileOilCost').textContent = gameConstants.NUCLEAR_MISSILE_OIL_COST;
            document.getElementById('nuclearMissileIronCost').textContent = gameConstants.NUCLEAR_MISSILE_IRON_COST;
            document.getElementById('sabotageCost').textContent = gameConstants.SABOTAGE_COST;
            document.getElementById('sabotageFailureCost').textContent = gameConstants.SABOTAGE_FAILURE_COST - gameConstants.SABOTAGE_COST;
            document.getElementById('railwayCost').textContent = gameConstants.RAILWAY_COST;
            document.getElementById('railwayIronCost').textContent = gameConstants.RAILWAY_IRON_COST;
            document.getElementById('railwayOilCost').textContent = gameConstants.RAILWAY_OIL_COST;
            document.getElementById('shinkansenCost').textContent = gameConstants.SHINKANSEN_COST;
            document.getElementById('shinkansenIronCost').textContent = gameConstants.SHINKANSEN_IRON_COST;
            document.getElementById('shinkansenOilCost').textContent = gameConstants.SHINKANSEN_OIL_COST;
            document.getElementById('airportCost').textContent = gameConstants.AIRPORT_COST;
            document.getElementById('airportIronCost').textContent = gameConstants.AIRPORT_IRON_COST;
            document.getElementById('airportOilCost').textContent = gameConstants.AIRPORT_OIL_COST;
            document.getElementById('tourismFacilityCost').textContent = gameConstants.TOURISM_FACILITY_COST;
            document.getElementById('tourismFacilityIronCost').textContent = gameConstants.TOURISM_FACILITY_IRON_COST;
            document.getElementById('tourismFacilityOilCost').textContent = gameConstants.TOURISM_FACILITY_OIL_COST;

            PEACE_COST_MONEY_PER_1000_CLIENT = gameConstants.PEACE_COST_MONEY_PER_1000;
            PEACE_COST_INFANTRY_CLIENT = gameConstants.PEACE_COST_INFANTRY;
            PEACE_COST_TANK_CLIENT = gameConstants.PEACE_COST_TANK;
            PEACE_COST_MECHANIZED_INFANTRY_CLIENT = gameConstants.PEACE_COST_MECHANIZED_INFANTRY;
            PEACE_COST_BOMBER_CLIENT = gameConstants.PEACE_COST_BOMBER;
            PEACE_COST_MISSILE_CLIENT = gameConstants.PEACE_COST_MISSILE;
            PEACE_COST_NUCLEAR_MISSILE_CLIENT = gameConstants.PEACE_COST_NUCLEAR_MISSILE;
            PEACE_COST_ARTILLERY_CLIENT = gameConstants.PEACE_COST_ARTILLERY;
            PEACE_COST_OIL_PER_10_CLIENT = gameConstants.PEACE_COST_OIL_PER_10;
            PEACE_COST_IRON_PER_10_CLIENT = gameConstants.PEACE_COST_IRON_PER_10;
            PEACE_COST_TERRITORY_CLIENT = gameConstants.PEACE_COST_TERRITORY;
            document.getElementById('maxRebellionsCount').textContent = gameConstants.MAX_REBELLIONS;
            BASE_TERRITORY_COST_CLIENT = gameConstants.BASE_TERRITORY_COST;
        }

        // ==========================================================
        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
        // ==========================================================
        let tutorialStep = 0;
        let tutorialActive = false;

        const tutorialMessages = [
            "ğŸŒ ã‚ˆã†ã“ãã€å›½é‹å–¶ã‚²ãƒ¼ãƒ ã¸ï¼\nã“ã‚Œã‹ã‚‰å›½ã‚’ä½œã£ã¦ã„ãæ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ï¼",
            "ã¾ãšã¯ã€Œç™»éŒ²ã™ã‚‹å›½åã€ã®éƒ¨åˆ†ã§å›½åã‚’å…¥åŠ›ã—ã¦ã€Œå›½ã‚’ç™»éŒ²ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚",
            "æ¬¡ã«ã‚µã‚¤ãƒˆä¸€ç•ªä¸‹ã®åœ°å›³ä¸Šã®ç°è‰²ã®åœ°åŸŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€é ˜åœŸã‚’1ã¤ç²å¾—ã—ã¾ã—ã‚‡ã†ï¼",
            "ç™»éŒ²ã§ããŸã‚‰ã€è»éšŠã‚’å¢—å¼·ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚è»éšŠå¢—å¼·ã§æ­©å…µã‚’1äººè¿½åŠ ã—ã¦ã¿ã¦ã­ã€‚æ­©å…µä»¥å¤–ã«ã‚‚ã„ã‚ã„ã‚ãªç¨®é¡ã®å…µå™¨ãŒã‚ã‚‹ã‚ˆ",
            "æ”»æ’ƒãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€æ•µã®é ˜åœŸã‚’é¸ã‚“ã§æ”»æ’ƒã§ãã¾ã™ãŒã€ä»Šå›ã¯èª¬æ˜ã ã‘ã«ã—ã¦ãŠãã¾ã™ã€‚",
            "ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ï¼ã“ã‚Œã‹ã‚‰è‡ªåˆ†ã®æˆ¦ç•¥ã§å›½ã‚’ç™ºå±•ã•ã›ã¦ã„ãã¾ã—ã‚‡ã†ğŸŒ"
        ];

        function startTutorial() {
            tutorialStep = 0;
            tutorialActive = true;
            showTutorialBox();
            nextTutorialStep();
        }

        function nextTutorialStep() {
            if (tutorialStep >= tutorialMessages.length) {
                endTutorial();
                return;
            }

            document.getElementById("tutorialText").textContent = tutorialMessages[tutorialStep];

            // ç‰¹å®šã®ã‚¹ãƒ†ãƒƒãƒ—ã«å¯¾å¿œã™ã‚‹å‹•ä½œã‚’èª˜å°
            if (tutorialStep === 1) { alert("å›½åã‚’å…¥åŠ›ã—ã¦ã€å›½ã‚’ç™»éŒ²ã€ã‚’æŠ¼ã—ã¦ã­ï¼"); }
            if (tutorialStep === 2) { isRegisteringNation = true; alert("åœ°å›³ä¸Šã®ç°è‰²åœ°åŸŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é ˜åœŸã‚’é¸ã³ã¾ã—ã‚‡ã†ï¼"); }
            if (tutorialStep === 3) { alert("ã€æ­©å…µã€ã‚’1äººå¢—å¼·ã—ã¦ã¿ã¦ãã ã•ã„ï¼"); }
            if (tutorialStep === 4) { alert("æ”»æ’ƒãƒ¢ãƒ¼ãƒ‰ã®èª¬æ˜ï¼šæ”»æ’ƒã¯ä»–å›½ã®é ˜åœŸã‚’å¥ªã†ãŸã‚ã®æ‰‹æ®µã§ã™ã€‚ä»Šå›ã¯ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãªã®ã§æ“ä½œã—ã¾ã›ã‚“ã€‚"); }

            tutorialStep++;
        }
        function startRegisterNation() {
            isRegisteringNation = true;
            alert("å›½ç™»éŒ²ãƒ¢ãƒ¼ãƒ‰ï¼");
        }
        function endTutorial() {
            tutorialActive = false;
            hideTutorialBox();
            alert("ğŸ‰ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†ï¼ãŒã‚“ã°ã£ã¦å›½ã‚’ç™ºå±•ã•ã›ã¦ã­ï¼");
        }

        function showTutorialBox() {
            document.getElementById("tutorialBox").style.display = "block";
        }

        function hideTutorialBox() {
            document.getElementById("tutorialBox").style.display = "none";
        }

        // New functions for missile mode
        function startMissileMode() {
            missileMode = true;
            nuclearMissileMode = false; // NEW
            attackMode = false;
            bombardMode = false;
            transferMode = false;
            updateModeStatus();
        }

        function endMissileMode() {
            missileMode = false;
            updateModeStatus();
        }

        // NEW: Nuclear missile mode functions
        function startNuclearMissileMode() {
            nuclearMissileMode = true;
            missileMode = false;
            attackMode = false;
            bombardMode = false;
            transferMode = false;
            updateModeStatus();
        }

        function endNuclearMissileMode() {
            nuclearMissileMode = false;
            updateModeStatus();
        }

        function updateModeStatus() {
            const statusDiv = document.getElementById("modeStatus");
            if (!statusDiv) { console.error("Error: Element with ID 'modeStatus' not found in the DOM."); return; }

            if (attackMode) {
                statusDiv.textContent = "æ”»æ’ƒãƒ¢ãƒ¼ãƒ‰ä¸­ï¼æ•µå›½ã®é ˜åœŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚";
                statusDiv.style.display = "block";
            } else if (bombardMode) {
                statusDiv.textContent = "çˆ†æ’ƒãƒ¢ãƒ¼ãƒ‰ä¸­ï¼çˆ†æ’ƒã—ãŸã„æ•µé ˜åœŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚";
                statusDiv.style.display = "block";
            } else if (missileMode) {
                statusDiv.textContent = "ãƒŸã‚µã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰ä¸­ï¼ãƒŸã‚µã‚¤ãƒ«ã‚’ç™ºå°„ã—ãŸã„æ•µé ˜åœŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚";
                statusDiv.style.display = "block";
            } else if (nuclearMissileMode) { // NEW
                statusDiv.textContent = "æ ¸ãƒŸã‚µã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰ä¸­ï¼æ ¸ãƒŸã‚µã‚¤ãƒ«ã‚’ç™ºå°„ã—ãŸã„æ•µé ˜åœŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚";
                statusDiv.style.display = "block";
            } else if (transferMode) {
                statusDiv.textContent = "é ˜åœŸè­²æ¸¡ãƒ¢ãƒ¼ãƒ‰ä¸­ï¼è­²æ¸¡ã—ãŸã„é ˜åœŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚";
                statusDiv.style.display = "block";
            } else {
                statusDiv.style.display = "none";
            }
        }

        function startAttackMode() {
            attackMode = true;
            bombardMode = false;
            missileMode = false;
            nuclearMissileMode = false; // NEW
            transferMode = false;
            updateModeStatus();
        }

        // New functions for bombardment mode
        function startBombardMode() {
            bombardMode = true;
            attackMode = false;
            missileMode = false;
            nuclearMissileMode = false; // NEW
            transferMode = false;
            updateModeStatus();
        }

        function endBombardMode() {
            bombardMode = false;
            updateModeStatus();
        }

        function getNationMap() {
            const map = {};
            nations.forEach(n => {
                n.territories.forEach(name => {
                    map[name] = n;
                });
            });
            return map;
        }

        function startTransferMode() {
            transferMode = true;
            attackMode = false;
            bombardMode = false;
            missileMode = false;
            nuclearMissileMode = false; // NEW
            updateModeStatus();
        }

        function endTransferMode() {
            transferMode = false;
            updateModeStatus();
        }

        // ==========================================================
        // APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–¢æ•°
        // ==========================================================

        async function loadNations() {
            try {
                const data = await fetchData('/api/nations');
                nations = data;
                nationNameToIpMap = {};
                nations.forEach(n => { nationNameToIpMap[n.name] = n.owner; });

                const myNation = nations.find(n => n.owner === currentUserIp);
                const flagUrlInput = document.getElementById('flagUrlInput');
                const currentFlagImage = document.getElementById('currentFlagImage');
                const noFlagMessage = document.getElementById('noFlagMessage');

                if (myNation) {
                    flagUrlInput.value = myNation.flagUrl || '';
                    if (myNation.flagUrl) {
                        currentFlagImage.src = myNation.flagUrl;
                        currentFlagImage.style.display = 'inline-block';
                        noFlagMessage.style.display = 'none';
                    } else {
                        currentFlagImage.src = '';
                        currentFlagImage.style.display = 'none';
                        noFlagMessage.style.display = 'block';
                    }
                } else {
                    flagUrlInput.value = '';
                    currentFlagImage.src = '';
                    currentFlagImage.style.display = 'none';
                    noFlagMessage.style.display = 'block';
                }

                const invasionStatusDiv = document.getElementById('invasionStatus');
                const startAttackModeBtn = document.getElementById('startAttackModeBtn');
                const startBombardModeBtn = document.getElementById('startBombardModeBtn');
                const startMissileModeBtn = document.getElementById('startMissileModeBtn');
                const startNuclearMissileModeBtn = document.getElementById('startNuclearMissileModeBtn');

                if (invasionStatusDiv) {
                    if (myNation && myNation.invasionStatus === 'in_progress') {
                        invasionStatusDiv.style.display = 'block';
                        if (startAttackModeBtn) startAttackModeBtn.disabled = true;
                        if (startBombardModeBtn) startBombardModeBtn.disabled = true;
                        if (startMissileModeBtn) startMissileModeBtn.disabled = true;
                        if (startNuclearMissileModeBtn) startNuclearMissileModeBtn.disabled = true;
                    } else {
                        invasionStatusDiv.style.display = 'none';
                        if (startAttackModeBtn) startAttackModeBtn.disabled = false;
                        if (startBombardModeBtn) startBombardModeBtn.disabled = false;
                        if (startMissileModeBtn) startMissileModeBtn.disabled = false;
                        if (startNuclearMissileModeBtn) startNuclearMissileModeBtn.disabled = false;
                    }
                }

                loadGeoJSON();
                loadAlliances();
                loadWars();
                loadFlightRequests();
                loadEstablishedFlights();
                loadNationalFocusStatus();
                // loadChatMessages(); // setIntervalã§ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
                loadOnlineUsers();
                loadTerritoryRanking();
            } catch (error) {
                alert(`å›½ã®æƒ…å ±å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        async function loadGeoJSON() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/smartnews-smri/japan-topography/refs/heads/main/data/constituency/geojson/s0001/senkyoku289polygon.json'); // publicãƒ•ã‚©ãƒ«ãƒ€ã¸ã®ãƒ‘ã‚¹
                const geojson = await response.json();

                if (geojsonLayer) map.removeLayer(geojsonLayer);

                const nationMap = getNationMap();
                geojsonLayer = L.geoJSON(geojson, {
                    style: feature => {
                        const name = feature.properties.kuname;
                        const nation = nationMap[name];
                        return {
                            fillColor: nation ? nation.color : '#ccc',
                            weight: 1,
                            color: '#333',
                            fillOpacity: 0.6,
                            dashArray: nation ? null : '3',
                        };
                    },
                    onEachFeature: (feature, layer) => {
                        const props = feature.properties;
                        const name = props.kuname;
                        const nation = nations.find(n => n.territories.includes(name));
                        layer.bindTooltip(props.kuname);

                        layer.on('click', async () => {
                            const clickedCountryName = props.kuname;

                            if (isRegisteringNation) {
                                const nationName = document.getElementById('nationNameInput').value.trim();
                                if (!nationName) { alert("å›½åãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
                                try {
                                    const result = await fetchData('/api/registerNation', 'POST', { nationName, countryName: clickedCountryName });
                                    alert(result.message);
                                    if (result.success) { isRegisteringNation = false; loadNations(); }
                                } catch (error) { alert(error.message); }
                                return;
                            }

                            if (attackMode && nation && nation.owner !== currentUserIp) {
                                const infantry = parseInt(document.getElementById('attackInfantry').value, 10);
                                const tank = parseInt(document.getElementById('attackTank').value, 10);
                                const mechInf = parseInt(document.getElementById('attackMechInf').value, 10);
                                const artillery = parseInt(document.getElementById('attackArtillery').value, 10);
                                if (isNaN(infantry) || isNaN(tank) || isNaN(mechInf) || isNaN(artillery) || infantry < 0 || tank < 0 || mechInf < 0 || artillery < 0) {
                                    alert("æ”»æ’ƒå…µåŠ›ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„"); return;
                                }
                                try {
                                    const result = await fetchData('/api/attackTerritory', 'POST', { targetCountryName: clickedCountryName, attackInfantry: infantry, attackTank: tank, attackMechanizedInfantry: mechInf, attackArtillery: artillery });
                                    alert(result.message);
                                    if (result.success) { attackMode = false; updateModeStatus(); loadNations(); loadWars(); }
                                } catch (error) { alert(error.message); }
                                return;
                            } else if (attackMode && nation && nation.owner === currentUserIp) { alert("è‡ªåˆ†ã®é ˜åœŸã‚’æ”»æ’ƒã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚"); return; }

                            if (bombardMode && nation && nation.owner !== currentUserIp) {
                                const numberOfBombers = parseInt(document.getElementById('bomberCount').value, 10);
                                if (isNaN(numberOfBombers) || numberOfBombers <= 0 || numberOfBombers > 100) { alert("çˆ†æ’ƒæ©Ÿæ•°ã‚’1ã‹ã‚‰100ã®é–“ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"); return; }
                                if (!confirm(`${props.kuname}ã‚’çˆ†æ’ƒæ©Ÿ${numberOfBombers}æ©Ÿã§çˆ†æ’ƒã—ã¾ã™ã‹ï¼Ÿ`)) { return; }
                                try {
                                    const result = await fetchData('/api/bombardTerritory', 'POST', { targetCountryName: clickedCountryName, numberOfBombers });
                                    alert(result.message);
                                    if (result.success) { bombardMode = false; updateModeStatus(); loadNations(); loadWars(); }
                                } catch (error) { alert(error.message); }
                                return;
                            } else if (bombardMode && nation && nation.owner === currentUserIp) { alert("è‡ªåˆ†ã®é ˜åœŸã‚’çˆ†æ’ƒã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚"); return; }

                            if (missileMode && nation && nation.owner !== currentUserIp) {
                                const missileCount = parseInt(document.getElementById('missileCount').value, 10);
                                if (isNaN(missileCount) || missileCount <= 0 || missileCount > 100) { alert("ãƒŸã‚µã‚¤ãƒ«ç™ºå°„æ•°ã¯1ã‹ã‚‰100ã®é–“ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"); return; }
                                if (!confirm(`${props.kuname}ã«ãƒŸã‚µã‚¤ãƒ«ã‚’${missileCount}ç™ºç™ºå°„ã—ã¾ã™ã‹ï¼Ÿï¼ˆå³æ™‚ç€å¼¾ï¼‰`)) { return; }
                                try {
                                    const result = await fetchData('/api/launchMissile', 'POST', { targetCountryName: clickedCountryName, numberOfMissiles: missileCount });
                                    alert(result.message);
                                    if (result.success) { missileMode = false; updateModeStatus(); loadNations(); loadWars(); }
                                } catch (error) { alert(error.message); }
                                return;
                            } else if (missileMode && nation && nation.owner === currentUserIp) { alert("è‡ªåˆ†ã®é ˜åœŸã«ãƒŸã‚µã‚¤ãƒ«ã‚’ç™ºå°„ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚"); return; }

                            if (nuclearMissileMode && nation && nation.owner !== currentUserIp) {
                                const nuclearMissileCount = parseInt(document.getElementById('nuclearMissileCount').value, 10);
                                if (isNaN(nuclearMissileCount) || nuclearMissileCount <= 0 || nuclearMissileCount > 5) { alert("æ ¸ãƒŸã‚µã‚¤ãƒ«ç™ºå°„æ•°ã¯1ã‹ã‚‰5ã®é–“ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"); return; }
                                if (!confirm(`${props.kuname}ã«æ ¸ãƒŸã‚µã‚¤ãƒ«ã‚’${nuclearMissileCount}ç™ºç™ºå°„ã—ã¾ã™ã‹ï¼Ÿï¼ˆå³æ™‚ç€å¼¾ã€ç”šå¤§ãªè¢«å®³ï¼‰`)) { return; }
                                try {
                                    const result = await fetchData('/api/launchNuclearMissile', 'POST', { targetCountryName: clickedCountryName, numberOfMissiles: nuclearMissileCount });
                                    alert(result.message);
                                    if (result.success) { nuclearMissileMode = false; updateModeStatus(); loadNations(); loadWars(); }
                                } catch (error) { alert(error.message); }
                                return;
                            } else if (nuclearMissileMode && nation && nation.owner === currentUserIp) { alert("è‡ªåˆ†ã®é ˜åœŸã«æ ¸ãƒŸã‚µã‚¤ãƒ«ã‚’ç™ºå°„ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚"); return; }

                            if (transferMode && nation && nation.owner === currentUserIp) {
                                const targetNationName = document.getElementById("transferNationName").value.trim();
                                if (!targetNationName) { alert("è­²æ¸¡å…ˆã®å›½åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
                                try {
                                    const result = await fetchData('/api/transferTerritory', 'POST', { territoryName: clickedCountryName, targetNationName });
                                    alert(result.message);
                                    if (result.success) { transferMode = false; updateModeStatus(); loadNations(); }
                                } catch (error) { alert(error.message); }
                                return;
                            } else if (transferMode && nation && nation.owner !== currentUserIp) { alert("ä»–å›½ã®é ˜åœŸã‚’è­²æ¸¡ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚"); return; }

                            if (nation) {
                                const isOwner = (nation.owner === currentUserIp);
                                const displayNationName = getTitleHtml(nation, nation.name);

                                const totalMilitaryPower = (nation.infantry * 2) + (nation.tank * 7) + (nation.mechanizedInfantry * 4) + (nation.artillery * 5);
                                const defenseRating = nation.territories.length > 0 ? (totalMilitaryPower / nation.territories.length).toFixed(1) : 0;

                                let info = `<b>${displayNationName}</b><br>æ‰€æŒè€…: ${nation.owner}<br>äººå£: ${nation.population}<br>`;
                                if (isOwner) {
                                    info += `ç·å…µåŠ› - æ­©å…µ: ${nation.infantry}, æˆ¦è»Š: ${nation.tank}, æ©Ÿæ¢°åŒ–æ­©å…µ: ${nation.mechanizedInfantry}, ç ²å…µ: ${nation.artillery}, çˆ†æ’ƒæ©Ÿ: ${nation.bomber}, ãƒŸã‚µã‚¤ãƒ«: ${nation.missile}, æ ¸ãƒŸã‚µã‚¤ãƒ«: ${nation.nuclearMissile}<br>` +
                                        `é˜²è¡›åŠ›: ${defenseRating} (ç·è»å‚™Ã·é ˜åœŸæ•°)<br>` +
                                        `ãŠé‡‘: ${nation.money}<br>` +
                                        `é‰„é“: ${nation.railways}æœ¬, æ–°å¹¹ç·š: ${nation.shinkansen}æœ¬, ç©ºæ¸¯: ${nation.airports}å€‹, è¦³å…‰æ–½è¨­: ${nation.tourismFacilities}å€‹<br>`;
                                } else {
                                    info += `é˜²è¡›åŠ›: ${defenseRating} (ç·è»å‚™Ã·é ˜åœŸæ•°)<br>`;
                                }
                                info += `çŸ³æ²¹: ${nation.oil}<br>` + `é‰„: ${nation.iron}<br>`;
                                layer.bindPopup(info).openPopup();

                            } else { // æœªæ‰€å±åœ°ã®è³¼å…¥
                                const myNation = nations.find(n => n.owner === currentUserIp);
                                const currentTerritoryCount = myNation ? myNation.territories.length : 0;
                                const nextPurchasePrice = (currentTerritoryCount + 1) * BASE_TERRITORY_COST_CLIENT;

                                if (!confirm(`${props.kuname} ã¯æœªæ‰€å±åœ°ã§ã™ã€‚${nextPurchasePrice} ãŠé‡‘ã§è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) { return; }
                                try {
                                    const result = await fetchData('/api/buyTerritory', 'POST', { countryName: clickedCountryName });
                                    alert(result.message);
                                } catch (error) { alert(error.message); }
                                loadNations(); // è³¼å…¥å¾Œã€å†èª­ã¿è¾¼ã¿
                            }
                        });
                    }
                }).addTo(map);
            } catch (error) {
                alert(`åœ°å›³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        async function reinforce() {
            const type = document.getElementById('unitType').value;
            const amount = parseInt(document.getElementById('unitAmount').value, 10);
            if (isNaN(amount) || amount <= 0) { alert("æ­£ã—ã„æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            try {
                const result = await fetchData('/api/reinforceArmy', 'POST', { type, amount });
                alert(result.message);
                loadNations();
            } catch (error) {
                alert(error.message);
            }
        }

        async function buildInfrastructure() {
            const type = document.getElementById('infrastructureType').value;
            const amount = parseInt(document.getElementById('infrastructureAmount').value, 10);
            if (isNaN(amount) || amount <= 0) { alert("æ­£ã—ã„æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            let costInfo = "";
            switch (type) {
                case 'railway': costInfo = `${gameConstants.RAILWAY_COST}å††, ${gameConstants.RAILWAY_IRON_COST}é‰„, ${gameConstants.RAILWAY_OIL_COST}çŸ³æ²¹`; break;
                case 'shinkansen': costInfo = `${gameConstants.SHINKANSEN_COST}å††, ${gameConstants.SHINKANSEN_IRON_COST}é‰„, ${gameConstants.SHINKANSEN_OIL_COST}çŸ³æ²¹`; break;
                case 'airport': costInfo = `${gameConstants.AIRPORT_COST}å††, ${gameConstants.AIRPORT_IRON_COST}é‰„, ${gameConstants.AIRPORT_OIL_COST}çŸ³æ²¹`; break;
                case 'tourismFacility': costInfo = `${gameConstants.TOURISM_FACILITY_COST}å††, ${gameConstants.TOURISM_FACILITY_IRON_COST}é‰„, ${gameConstants.TOURISM_FACILITY_OIL_COST}çŸ³æ²¹`; break;
            }

            if (!confirm(`${amount}å€‹å»ºè¨­ã—ã¾ã™ã‹ï¼Ÿ\n(1å€‹ã‚ãŸã‚Š: ${costInfo})`)) { return; }

            try {
                const result = await fetchData('/api/buildInfrastructure', 'POST', { type, amount });
                alert(result.message);
                loadNations();
            } catch (error) {
                alert(error.message);
            }
        }

        async function requestFlight() {
            const targetNationName = document.getElementById('flightTargetNationName').value.trim();
            if (!targetNationName) { alert("é£›è¡Œæ©Ÿä¾¿ç”³è«‹å…ˆã®å›½åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            try {
                const result = await fetchData('/api/requestFlight', 'POST', { targetNationName });
                alert(result.message);
                loadFlightRequests();
            } catch (error) { alert(error.message); }
        }

        async function respondToFlightRequest(requesterIp, response) {
            try {
                const result = await fetchData('/api/respondToFlightRequest', 'POST', { requesterIp, response });
                alert(result.message);
                loadFlightRequests();
                loadEstablishedFlights();
                loadNations();
            } catch (error) { alert(error.message); }
        }

        async function loadFlightRequests() {
            try {
                const data = await fetchData('/api/getPendingFlightRequests');
                const pendingList = document.getElementById('pendingFlightRequests');
                pendingList.innerHTML = '';
                if (data.length === 0) {
                    pendingList.innerHTML = '<li>ç¾åœ¨ã€ã‚ãªãŸã¸ã®é£›è¡Œæ©Ÿä¾¿ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
                } else {
                    data.forEach(req => {
                        const li = document.createElement('li');
                        li.innerHTML = `${req.requesterNationName} ã‹ã‚‰ã®ç”³è«‹ <button onclick="respondToFlightRequest('${req.requesterIp}', 'approve')">æ‰¿èª</button> <button onclick="respondToFlightRequest('${req.requesterIp}', 'reject')">æ‹’å¦</button>`;
                        pendingList.appendChild(li);
                    });
                }
            } catch (error) { console.error('é£›è¡Œæ©Ÿä¾¿ç”³è«‹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error); }
        }

        async function loadEstablishedFlights() {
            try {
                const data = await fetchData('/api/getEstablishedFlights');
                const establishedList = document.getElementById('establishedFlights');
                establishedList.innerHTML = '';
                if (data.length === 0) {
                    establishedList.innerHTML = '<li>ç¾åœ¨ã€ç¢ºç«‹ã•ã‚ŒãŸé£›è¡Œæ©Ÿä¾¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
                } else {
                    data.forEach(flight => {
                        const li = document.createElement('li');
                        li.textContent = `${flight.targetNationName} (${flight.status === 'approved' ? 'æ‰¿èªæ¸ˆã¿' : flight.status})`;
                        establishedList.appendChild(li);
                    });
                }
            } catch (error) { console.error('ç¢ºç«‹ã•ã‚ŒãŸé£›è¡Œæ©Ÿä¾¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error); }
        }

        async function spy() {
            const target = document.getElementById('spyTargetNation').value.trim();
            if (!target) { alert("ã‚¹ãƒ‘ã‚¤å¯¾è±¡ã®å›½åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            const resultDiv = document.getElementById('spyResult');
            try {
                const res = await fetchData('/api/spyNation', 'POST', { targetNationName: target });
                let info = res.info;
                resultDiv.innerHTML = `
                <p>ã‚¹ãƒ‘ã‚¤æˆåŠŸï¼ ${res.message}</p>
                <p>æ­©å…µ: ${info.infantry}ä½“</p>
                <p>æˆ¦è»Š: ${info.tank}å°</p>
                <p>æ©Ÿæ¢°åŒ–æ­©å…µ: ${info.mechanizedInfantry}ä½“</p>
                <p>ç ²å…µ: ${info.artillery}ä½“</p>
                <p>çˆ†æ’ƒæ©Ÿ: ${info.bomber}æ©Ÿ</p>
                <p>ãƒŸã‚µã‚¤ãƒ«: ${info.missile}æ©Ÿ</p>
                <p>æ ¸ãƒŸã‚µã‚¤ãƒ«: ${info.nuclearMissile}æ©Ÿ</p>
                <p>ãŠé‡‘: ${info.money}å††</p>
                <p>çŸ³æ²¹: ${info.oil}å€‹</p>
                <p>é‰„: ${info.iron}å€‹</p>
                <p>é‰„é“: ${info.railways}æœ¬</p>
                <p>æ–°å¹¹ç·š: ${info.shinkansen}æœ¬</p>
                <p>ç©ºæ¸¯: ${info.airports}å€‹</p>
                <p>è¦³å…‰æ–½è¨­: ${info.tourismFacilities}å€‹</p>
            `;
            } catch (error) {
                alert(error.message);
                resultDiv.innerHTML = "";
            }
        }

        async function sabotage() {
            const target = document.getElementById('sabotageTargetNation').value.trim();
            if (!target) { alert("ç ´å£Šå·¥ä½œå¯¾è±¡ã®å›½åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            if (!confirm(`ç ´å£Šå·¥ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nã‚³ã‚¹ãƒˆ: ${SABOTAGE_COST_CLIENT}å†† (å¤±æ•—æ™‚: è¿½åŠ ã§${SABOTAGE_FAILURE_COST_CLIENT - SABOTAGE_COST_CLIENT}å††)`)) { return; }
            try {
                const result = await fetchData('/api/sabotageNation', 'POST', { targetNationName: target });
                alert(result.message);
                loadNations();
            } catch (error) {
                alert(error.message);
            }
        }

        async function sendResourcesByName() {
            const name = document.getElementById("targetNationName").value.trim();
            const type = document.getElementById("resourceType").value;
            const amount = document.getElementById("resourceAmount").value;

            if (!name) { alert("ç›¸æ‰‹ã®å›½åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

            try {
                const res = await fetchData('/api/transferResourcesByName', 'POST', { toNationName: name, type, amount });
                alert(res.message);
                loadNations();
            } catch (error) {
                alert(error.message);
            }
        }

        async function loadNews() {
            try {
                const newsArray = await fetchData('/api/news');
                const list = document.getElementById("newsList");
                list.innerHTML = "";
                newsArray.forEach(line => {
                    const li = document.createElement("li");
                    li.textContent = line;
                    list.insertBefore(li, list.firstChild);
                });
            } catch (error) { console.error('ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error); }
        }

        function getTitleHtml(nationObject, nationName) {
            let flagHtml = '';
            if (nationObject && nationObject.flagUrl) {
                flagHtml = `<img src="${nationObject.flagUrl}" alt="Flag" class="flag-icon" onerror="this.style.display='none'"> `;
            }

            if (!nationObject || !nationObject.selectedTitleId || !titleDefinitions[nationObject.selectedTitleId]) {
                return `${flagHtml}${nationName}`;
            }
            const titleInfo = titleDefinitions[nationObject.selectedTitleId];
            const glowStyle = `text-shadow: 0 0 5px ${titleInfo.color}, 0 0 10px ${titleInfo.color}, 0 0 15px ${titleInfo.color}; color: ${titleInfo.color};`;
            return `${flagHtml}<span class="glowing-text" style="${glowStyle}">ã€${titleInfo.name}ã€‘</span> ${nationName}`;
        }

        async function loadChatMessages() {
            try {
                const messages = await fetchData('/api/chatMessages');
                const chatLog = document.getElementById("chatLog");
                const shouldScroll = chatLog.scrollTop + chatLog.clientHeight === chatLog.scrollHeight || chatLog.scrollTop === 0;

                chatLog.innerHTML = "";
                messages.forEach(msg => {
                    const p = document.createElement("p");
                    const mockNationObject = { selectedTitleId: msg.selectedTitleId, flagUrl: msg.flagUrl };
                    const displayNationNameWithTitle = getTitleHtml(mockNationObject, msg.nationName);

                    p.innerHTML = `<span class="chat-time">[${msg.time}]</span> <span class="chat-name">${displayNationNameWithTitle}:</span> ${msg.message}`;
                    chatLog.appendChild(p);
                });

                if (shouldScroll) {
                    chatLog.scrollTop = chatLog.scrollHeight;
                }
            } catch (error) { console.error('ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error); }
        }

        async function sendChatMessage() {
            const input = document.getElementById("chatInput");
            const message = input.value.trim();
            if (message) {
                try {
                    await fetchData('/api/postChatMessage', 'POST', { message });
                    input.value = "";
                    loadChatMessages();
                } catch (error) {
                    alert(error.message);
                }
            }
        }

        // --- Alliance JavaScript Functions ---
        async function requestAlliance() {
            const targetNationName = document.getElementById('allianceTargetNationName').value.trim();
            if (!targetNationName) { alert("åŒç›Ÿç”³è«‹å…ˆã®å›½åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            try {
                const result = await fetchData('/api/requestAlliance', 'POST', { targetNationName });
                alert(result.message);
                loadAlliances();
            } catch (error) { alert(error.message); }
        }

        async function respondToAllianceRequest(requesterIp, response) {
            try {
                const result = await fetchData('/api/respondToAllianceRequest', 'POST', { requesterIp, response });
                alert(result.message);
                loadAlliances();
            } catch (error) { alert(error.message); }
        }

        async function loadAlliances() {
            try {
                const data = await fetchData('/api/getAlliances');
                const pendingList = document.getElementById('pendingAllianceRequests');
                pendingList.innerHTML = '';
                if (data.pendingRequests.length === 0) {
                    pendingList.innerHTML = '<li>ç¾åœ¨ã€ã‚ãªãŸã¸ã®åŒç›Ÿç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
                } else {
                    data.pendingRequests.forEach(req => {
                        const li = document.createElement('li');
                        li.innerHTML = `${req.requesterNationName} ã‹ã‚‰ã®ç”³è«‹ <button onclick="respondToAllianceRequest('${req.requesterIp}', 'approve')">æ‰¿èª</button> <button onclick="respondToAllianceRequest('${req.requesterIp}', 'reject')">æ‹’å¦</button>`;
                        pendingList.appendChild(li);
                    });
                }

                const currentList = document.getElementById('currentAlliances');
                currentList.innerHTML = '';
                if (data.approvedAlliances.length === 0) {
                    currentList.innerHTML = '<li>ç¾åœ¨ã€åŒç›Ÿå›½ã¯ã„ã¾ã›ã‚“ã€‚</li>';
                } else {
                    data.approvedAlliances.forEach(alliance => {
                        const li = document.createElement('li');
                        li.innerHTML = `${alliance.nationName} <button onclick="dissolveAlliance('${alliance.ip}')">è§£é™¤</button>`;
                        currentList.appendChild(li);
                    });
                }
            } catch (error) { console.error('åŒç›Ÿæƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error); }
        }

        async function dissolveAlliance(alliedNationIp) {
            if (confirm('æœ¬å½“ã«ã“ã®åŒç›Ÿã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    const result = await fetchData('/api/dissolveAlliance', 'POST', { alliedNationIp });
                    alert(result.message);
                    loadAlliances();
                } catch (error) { alert(error.message); }
            }
        }

        async function loadOnlineUsers() {
            try {
                const onlineUsersData = await fetchData('/api/getOnlineUserNames');
                const list = document.getElementById("onlineUsersList");
                list.innerHTML = "";

                if (onlineUsersData.length === 0) {
                    list.innerHTML = "<li>ç¾åœ¨ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</li>";
                } else {
                    onlineUsersData.forEach(userData => {
                        const li = document.createElement("li");
                        const mockNationObject = { selectedTitleId: userData.selectedTitleId, flagUrl: userData.flagUrl };
                        const displayNationName = getTitleHtml(mockNationObject, userData.nationName);
                        li.innerHTML = displayNationName;
                        list.appendChild(li);
                    });
                }
            } catch (error) { console.error('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error); }
        }

        async function loadTerritoryRanking() {
            try {
                const rankingData = await fetchData('/api/getTerritoryRanking');
                const list = document.getElementById("territoryRankingList");
                list.innerHTML = "";
                if (rankingData.length === 0) {
                    list.innerHTML = "<li>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>";
                } else {
                    rankingData.forEach((nation, index) => {
                        const li = document.createElement("li");
                        const mockNationObject = { selectedTitleId: nation.selectedTitleId, flagUrl: nation.flagUrl };
                        const displayNationName = getTitleHtml(mockNationObject, nation.name);
                        li.innerHTML = `${index + 1}. ${displayNationName} (${nation.territories}é ˜åœŸ)`;
                        list.appendChild(li);
                    });
                }
            } catch (error) { console.error('é ˜åœŸãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error); }
        }

        async function changeNationInfo() {
            const newName = document.getElementById('newNationNameInput').value.trim();
            const newColor = document.getElementById('newNationColorInput').value;

            if (!newName && newColor === '#4a90e2') { // #4a90e2ã¯HTMLã§è¨­å®šã•ã‚ŒãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²
                alert("æ–°ã—ã„å›½åã‹æ–°ã—ã„è‰²ã®ã©ã¡ã‚‰ã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            try {
                const result = await fetchData('/api/updateNationInfo', 'POST', { newName, newColor });
                alert(result.message);
                if (result.success) { loadNations(); }
            } catch (error) { alert(error.message); }
        }

        async function updateFlagFromUrl() {
            const newFlagUrl = document.getElementById('flagUrlInput').value.trim();
            try {
                const result = await fetchData('/api/updateNationFlag', 'POST', { newFlagUrl });
                alert(result.message);
                if (result.success) { loadNations(); }
            } catch (error) { alert(error.message); }
        }

        document.getElementById('flagFileInput').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64String = e.target.result;
                    try {
                        const result = await fetchData('/api/updateNationFlag', 'POST', { newFlagUrl: base64String });
                        alert(result.message);
                        if (result.success) { loadNations(); }
                    } catch (error) { alert(error.message); }
                };
                reader.readAsDataURL(file);
            }
        });

        async function attemptRebellion() {
            const targetCountryName = document.getElementById('rebellionTargetCountryName').value.trim();
            if (!targetCountryName) { alert("åä¹±ã‚’èµ·ã“ã™é ˜åœŸåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            if (!confirm(`${targetCountryName}ã§åä¹±ã‚’èµ·ã“ã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚ãªãŸã¯ç¾åœ¨é ˜åœŸã‚’æ‰€æœ‰ã—ã¦ã„ãªã„å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰`)) { return; }
            try {
                const result = await fetchData('/api/attemptRebellion', 'POST', { targetCountryName });
                alert(result.message);
                if (result.success) { loadNations(); }
            } catch (error) { alert(error.message); }
        }

        async function declareWar() {
            const targetNationName = document.getElementById('warTargetNationName').value.trim();
            if (!targetNationName) { alert("å®£æˆ¦å¸ƒå‘Šå¯¾è±¡ã®å›½åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
            if (!confirm(`${targetNationName}ã«å®£æˆ¦å¸ƒå‘Šã—ã¾ã™ã‹ï¼Ÿ`)) { return; }
            try {
                const result = await fetchData('/api/declareWar', 'POST', { targetNationName });
                alert(result.message);
                if (result.success) { loadWars(); }
            } catch (error) { alert(error.message); }
        }

        async function proposeCeasefire(warId) {
            if (!confirm(`ã“ã®æˆ¦äº‰ã®åœæˆ¦ã‚’ææ¡ˆã—ã¾ã™ã‹ï¼Ÿ`)) { return; }
            try {
                const result = await fetchData('/api/proposeCeasefire', 'POST', { warId });
                alert(result.message);
                if (result.success) { loadWars(); }
            } catch (error) { alert(error.message); }
        }

        async function acceptCeasefire(warId) {
            if (!confirm(`ã“ã®åœæˆ¦ææ¡ˆã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ`)) { return; }
            try {
                const result = await fetchData('/api/acceptCeasefire', 'POST', { warId });
                alert(result.message);
                if (result.success) { loadWars(); }
            } catch (error) { alert(error.message); }
        }

        async function rejectCeasefire(warId, proposerName) {
            if (!confirm(`${proposerName}ã‹ã‚‰ã®åœæˆ¦ææ¡ˆã‚’æ‹’å¦ã—ã¾ã™ã‹ï¼Ÿæˆ¦äº‰ãŒç¶™ç¶šã—ã¾ã™ã€‚`)) { return; }
            try {
                const result = await fetchData('/api/rejectCeasefire', 'POST', { warId });
                alert(result.message);
                if (result.success) { loadWars(); }
            } catch (error) { alert(error.message); }
        }

        async function proposeWhitePeace(warId) {
            if (!confirm(`ã“ã®æˆ¦äº‰ã®ç™½ç´™è¬›å’Œã‚’ææ¡ˆã—ã¾ã™ã‹ï¼Ÿï¼ˆæ‰¿èªã•ã‚Œã‚‹ã¨é ˜åœŸã¯æˆ¦äº‰å‰ã®çŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™ï¼‰`)) { return; }
            try {
                const result = await fetchData('/api/proposeWhitePeace', 'POST', { warId });
                alert(result.message);
                if (result.success) { loadWars(); }
            } catch (error) { alert(error.message); }
        }

        async function acceptWhitePeace(warId) {
            if (!confirm(`ã“ã®ç™½ç´™è¬›å’Œææ¡ˆã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿï¼ˆé ˜åœŸã¯æˆ¦äº‰å‰ã®çŠ¶æ…‹ã«æˆ»ã‚Šã€æˆ¦äº‰ãŒçµ‚äº†ã—ã¾ã™ï¼‰`)) { return; }
            try {
                const result = await fetchData('/api/acceptWhitePeace', 'POST', { warId });
                alert(result.message);
                if (result.success) { loadWars(); loadNations(); }
            } catch (error) { alert(error.message); }
        }

        async function rejectWhitePeace(warId, proposerName) {
            if (!confirm(`${proposerName}ã‹ã‚‰ã®ç™½ç´™è¬›å’Œææ¡ˆã‚’æ‹’å¦ã—ã¾ã™ã‹ï¼Ÿæˆ¦äº‰ãŒç¶™ç¶šã—ã¾ã™ã€‚`)) { return; }
            try {
                const result = await fetchData('/api/rejectWhitePeace', 'POST', { warId });
                alert(result.message);
                if (result.success) { loadWars(); }
            } catch (error) { alert(error.message); }
        }

        async function cancelWar(warId) {
            if (!confirm(`ã“ã®æˆ¦äº‰ã‚’ä¸­æ­¢ã—ã¾ã™ã‹ï¼Ÿï¼ˆè¬›å’Œä¼šè­°ãªã—ã§çµ‚äº†ï¼‰`)) { return; }
            try {
                const result = await fetchData('/api/cancelWar', 'POST', { warId });
                alert(result.message);
                if (result.success) { loadWars(); loadNations(); }
            } catch (error) { alert(error.message); }
        }

        async function loadWars() {
            if (!currentUserIp) { console.warn('âš  currentUserIp ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚loadWars ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚'); return; }

            try {
                const data = await fetchData('/api/getUserWars');
                const activeWarsList = document.getElementById('activeWarsList');
                const ceasefireProposalsList = document.getElementById('ceasefireProposalsList');
                const whitePeaceProposalsList = document.getElementById('whitePeaceProposalsList');

                activeWarsList.innerHTML = '';
                ceasefireProposalsList.innerHTML = '';
                whitePeaceProposalsList.innerHTML = '';

                if (data && Array.isArray(data.activeWars)) {
                    if (data.activeWars.length === 0) {
                        activeWarsList.innerHTML = '<li>ç¾åœ¨ã€é€²è¡Œä¸­ã®æˆ¦äº‰ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
                    } else {
                        data.activeWars.forEach(war => {
                            const li = document.createElement('li');
                            const isMyWar = (war.attackerIp === currentUserIp || war.defenderIp === currentUserIp);

                            let warStatusText = {
                                'Declared': '<span class="war-status-declared">å®£æˆ¦å¸ƒå‘Šæ¸ˆã¿</span>',
                                'Ongoing': '<span class="war-status-ongoing">æˆ¦äº‰ä¸­</span>',
                                'Ceasefire': '<span class="war-status-ceasefire">åœæˆ¦ä¸­</span>',
                                'Ended': '<span class="war-status-ended">çµ‚äº†</span>',
                                'Cancelled': '<span class="war-status-cancelled">ä¸­æ­¢</span>',
                                'WhitePeaceProposed': '<span class="war-status-whitepeaceproposed">ç™½ç´™è¬›å’Œææ¡ˆä¸­</span>'
                            }[war.status] || '';

                            li.innerHTML = `
                                <b>${war.attackerNationName}</b> vs <b>${war.defenderNationName}</b> (${warStatusText}) <br>
                                <small>ã‚¹ã‚³ã‚¢: ${war.attackerNationName}: ${war.attackerWarScore} - ${war.defenderNationName}: ${war.defenderWarScore}</small>
                            `;

                            let buttonsHtml = '';
                            if (isMyWar) {
                                if ((war.status === 'Declared' || war.status === 'Ongoing') && war.ceasefireProposedBy !== currentUserIp) {
                                    buttonsHtml += `<button onclick="proposeCeasefire('${war.warId}')" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8em;"><i class="fas fa-handshake"></i> åœæˆ¦ææ¡ˆ</button>`;
                                    buttonsHtml += `<button onclick="proposeWhitePeace('${war.warId}')" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8em; background-color: #800080;"><i class="fas fa-peace"></i> ç™½ç´™è¬›å’Œææ¡ˆ</button>`;
                                } else if ((war.status === 'Declared' || war.status === 'Ongoing') && war.ceasefireProposedBy === currentUserIp) {
                                    buttonsHtml += `<span style="margin-left: 10px; color: #6c757d; font-size: 0.8em;">åœæˆ¦ææ¡ˆæ¸ˆã¿</span>`;
                                } else if (war.status === WAR_STATUS_WHITE_PEACE_PROPOSED && war.ceasefireProposedBy === currentUserIp) {
                                    buttonsHtml += `<span style="margin-left: 10px; color: #6c757d; font-size: 0.8em;">ç™½ç´™è¬›å’Œææ¡ˆæ¸ˆã¿</span>`;
                                }

                                if (war.status === 'Ceasefire') {
                                    const myWarScore = war.attackerIp === currentUserIp ? war.attackerWarScore : war.defenderWarScore;
                                    const opponentWarScore = war.attackerIp === currentUserIp ? war.defenderWarScore : war.attackerWarScore;
                                    if (myWarScore > opponentWarScore) {
                                        buttonsHtml += `<button onclick="openPeaceConferenceModal('${war.warId}')" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8em; background-color: #28a745;"><i class="fas fa-gavel"></i> è¬›å’Œä¼šè­°</button>`;
                                    }
                                }
                            }

                            li.innerHTML += buttonsHtml;
                            activeWarsList.appendChild(li);
                        });
                    }
                }

                if (data && Array.isArray(data.ceasefireProposals)) {
                    if (data.ceasefireProposals.length === 0) {
                        ceasefireProposalsList.innerHTML = '<li>ç¾åœ¨ã€ã‚ãªãŸã¸ã®åœæˆ¦ææ¡ˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
                    } else {
                        data.ceasefireProposals.forEach(proposal => {
                            const li = document.createElement('li');
                            const proposerName = (proposal.attackerIp === proposal.ceasefireProposedBy) ? proposal.attackerNationName : proposal.defenderNationName;
                            li.innerHTML = `
                                <b>${proposal.attackerNationName}</b> vs <b>${proposal.defenderNationName}</b> - ææ¡ˆè€…: ${proposerName}
                                <button onclick="acceptCeasefire('${proposal.warId}')" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8em; background-color: #28a745;"><i class="fas fa-check"></i> æ‰¿èª</button>
                                <button onclick="rejectCeasefire('${proposal.warId}', '${proposerName}')" style="margin-left: 5px; padding: 5px 10px; font-size: 0.8em; background-color: #dc3545;"><i class="fas fa-times"></i> æ‹’å¦</button>
                            `;
                            ceasefireProposalsList.appendChild(li);
                        });
                    }
                }

                if (data && Array.isArray(data.whitePeaceProposals)) {
                    if (data.whitePeaceProposals.length === 0) {
                        whitePeaceProposalsList.innerHTML = '<li>ç¾åœ¨ã€ã‚ãªãŸã¸ã®ç™½ç´™è¬›å’Œææ¡ˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
                    } else {
                        data.whitePeaceProposals.forEach(proposal => {
                            const li = document.createElement('li');
                            const proposerName = (proposal.attackerIp === proposal.ceasefireProposedBy) ? proposal.attackerNationName : proposal.defenderNationName;
                            li.innerHTML = `
                                <b>${proposal.attackerNationName}</b> vs <b>${proposal.defenderNationName}</b> - ææ¡ˆè€…: ${proposerName}
                                <button onclick="acceptWhitePeace('${proposal.warId}')" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8em; background-color: #28a745;"><i class="fas fa-check"></i> æ‰¿èª</button>
                                <button onclick="rejectWhitePeace('${proposal.warId}', '${proposerName}')" style="margin-left: 5px; padding: 5px 10px; font-size: 0.8em; background-color: #dc3545;"><i class="fas fa-times"></i> æ‹’å¦</button>
                            `;
                            whitePeaceProposalsList.appendChild(li);
                        });
                    }
                }
            } catch (error) {
                console.error("ğŸ›‘ æˆ¦äº‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error.message, error.stack);
                activeWarsList.innerHTML = '<li>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</li>';
                ceasefireProposalsList.innerHTML = '<li>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</li>';
                whitePeaceProposalsList.innerHTML = '<li>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</li>';
            }
        }

        // --- Peace Conference Modal Functions ---
        async function openPeaceConferenceModal(warId) {
            try {
                const result = await fetchData('/api/startPeaceConference', 'POST', { warId });
                if (!result.success) { alert(result.message); return; }
                currentPeaceConferenceWar = result;

                document.getElementById('pcWarId').textContent = result.war.warId;
                document.getElementById('pcWinnerNation').textContent = result.winnerNationName;
                document.getElementById('pcLoserNation').textContent = result.loserNationName;
                document.getElementById('pcAvailableWarPoints').textContent = result.availableWarPoints;

                document.getElementById('pcMoney').max = result.loserCurrentMoney;
                document.getElementById('pcMoney').value = 0;
                document.getElementById('pcLoserMoney').textContent = result.loserCurrentMoney;

                document.getElementById('pcOil').max = result.loserCurrentOil;
                document.getElementById('pcOil').value = 0;
                document.getElementById('pcLoserOil').textContent = result.loserCurrentOil;

                document.getElementById('pcIron').max = result.loserCurrentIron;
                document.getElementById('pcIron').value = 0;
                document.getElementById('pcLoserIron').textContent = result.loserCurrentIron;

                document.getElementById('pcInfantry').max = result.loserCurrentInfantry;
                document.getElementById('pcInfantry').value = 0;
                document.getElementById('pcLoserInfantry').textContent = result.loserCurrentInfantry;

                document.getElementById('pcTank').max = result.loserCurrentTank;
                document.getElementById('pcTank').value = 0;
                document.getElementById('pcLoserTank').textContent = result.loserCurrentTank;

                document.getElementById('pcMechanizedInfantry').max = result.loserCurrentMechanizedInfantry;
                document.getElementById('pcMechanizedInfantry').value = 0;
                document.getElementById('pcLoserMechanizedInfantry').textContent = result.loserCurrentMechanizedInfantry;

                document.getElementById('pcArtillery').max = result.loserCurrentArtillery;
                document.getElementById('pcArtillery').value = 0;
                document.getElementById('pcLoserArtillery').textContent = result.loserCurrentArtillery;

                document.getElementById('pcBomber').max = result.loserCurrentBomber;
                document.getElementById('pcBomber').value = 0;
                document.getElementById('pcLoserBomber').textContent = result.loserCurrentBomber;

                document.getElementById('pcMissile').max = result.loserCurrentMissile;
                document.getElementById('pcMissile').value = 0;
                document.getElementById('pcLoserMissile').textContent = result.loserCurrentMissile;

                document.getElementById('pcNuclearMissile').max = result.loserCurrentNuclearMissile;
                document.getElementById('pcNuclearMissile').value = 0;
                document.getElementById('pcLoserNuclearMissile').textContent = result.loserCurrentNuclearMissile;

                const territoriesSelect = document.getElementById('peaceDemandsTerritories');
                territoriesSelect.innerHTML = '';
                result.loserTerritories.forEach(territory => {
                    const option = document.createElement('option');
                    option.value = territory;
                    option.textContent = territory;
                    territoriesSelect.appendChild(option);
                });

                calculatePeaceDemandsCost();
                document.getElementById('peaceConferenceModal').style.display = 'block';

            } catch (error) { alert(error.message); }
        }

        function closePeaceConferenceModal() {
            document.getElementById('peaceConferenceModal').style.display = 'none';
            currentPeaceConferenceWar = null;
            loadWars();
            loadNations();
        }

        function calculatePeaceDemandsCost() {
            let totalCost = 0;

            const moneyInput = document.getElementById('pcMoney');
            const oilInput = document.getElementById('pcOil');
            const ironInput = document.getElementById('pcIron');
            const infantryInput = document.getElementById('pcInfantry');
            const tankInput = document.getElementById('pcTank');
            const mechanizedInfantryInput = document.getElementById('pcMechanizedInfantry');
            const artilleryInput = document.getElementById('pcArtillery');
            const bomberInput = document.getElementById('pcBomber');
            const missileInput = document.getElementById('pcMissile');
            const nuclearMissileInput = document.getElementById('pcNuclearMissile');

            const money = moneyInput ? (parseInt(moneyInput.value) || 0) : 0;
            const oil = oilInput ? (parseInt(oilInput.value) || 0) : 0;
            const iron = ironInput ? (parseInt(ironInput.value) || 0) : 0;
            const infantry = infantryInput ? (parseInt(infantryInput.value) || 0) : 0;
            const tank = tankInput ? (parseInt(tankInput.value) || 0) : 0;
            const mechanizedInfantry = mechanizedInfantryInput ? (parseInt(mechanizedInfantryInput.value) || 0) : 0;
            const artillery = artilleryInput ? (parseInt(artilleryInput.value) || 0) : 0;
            const bomber = bomberInput ? (parseInt(bomberInput.value) || 0) : 0;
            const missile = missileInput ? (parseInt(missileInput.value) || 0) : 0;
            const nuclearMissile = nuclearMissileInput ? (parseInt(nuclearMissileInput.value) || 0) : 0;

            const territoriesSelect = document.getElementById('peaceDemandsTerritories');
            const selectedTerritories = territoriesSelect ? Array.from(territoriesSelect.selectedOptions).map(option => option.value) : [];

            const moneyCost = Math.ceil(money / 1000) * PEACE_COST_MONEY_PER_1000_CLIENT;
            const oilCost = Math.ceil(oil / 10) * PEACE_COST_OIL_PER_10_CLIENT;
            const ironCost = Math.ceil(iron / 10) * PEACE_COST_IRON_PER_10_CLIENT;
            const infantryCost = infantry * PEACE_COST_INFANTRY_CLIENT;
            const tankCost = tank * PEACE_COST_TANK_CLIENT;
            const mechanizedInfantryCost = mechanizedInfantry * PEACE_COST_MECHANIZED_INFANTRY_CLIENT;
            const artilleryCost = artillery * PEACE_COST_ARTILLERY_CLIENT;
            const bomberCost = bomber * PEACE_COST_BOMBER_CLIENT;
            const missileCost = missile * PEACE_COST_MISSILE_CLIENT;
            const nuclearMissileCost = nuclearMissile * PEACE_COST_NUCLEAR_MISSIILE_CLIENT;
            const territoryCost = selectedTerritories.length * PEACE_COST_TERRITORY_CLIENT;

            totalCost = moneyCost + oilCost + ironCost + infantryCost + tankCost + mechanizedInfantryCost + artilleryCost + bomberCost + missileCost + nuclearMissileCost + territoryCost;

            if (document.getElementById('pcMoneyCost')) document.getElementById('pcMoneyCost').textContent = moneyCost;
            if (document.getElementById('pcOilCost')) document.getElementById('pcOilCost').textContent = oilCost;
            if (document.getElementById('pcIronCost')) document.getElementById('pcIronCost').textContent = ironCost;
            if (document.getElementById('pcInfantryCost')) document.getElementById('pcInfantryCost').textContent = infantryCost;
            if (document.getElementById('pcTankCost')) document.getElementById('pcTankCost').textContent = tankCost;
            if (document.getElementById('pcMechanizedInfantryCost')) document.getElementById('pcMechanizedInfantryCost').textContent = mechanizedInfantryCost;
            if (document.getElementById('pcArtilleryCost')) document.getElementById('pcArtilleryCost').textContent = artilleryCost;
            if (document.getElementById('pcBomberCost')) document.getElementById('pcBomberCost').textContent = bomberCost;
            if (document.getElementById('pcMissileCost')) document.getElementById('pcMissileCost').textContent = missileCost;
            if (document.getElementById('pcNuclearMissileCost')) document.getElementById('pcNuclearMissileCost').textContent = nuclearMissileCost;
            if (document.getElementById('pcTerritoryCost')) document.getElementById('pcTerritoryCost').textContent = territoryCost;
            if (document.getElementById('pcDemandsCost')) document.getElementById('pcDemandsCost').textContent = totalCost;

            return totalCost;
        }

        async function makePeaceDemands() {
            const warId = document.getElementById('pcWarId').textContent;
            const totalCost = calculatePeaceDemandsCost();
            const availableWarPoints = parseInt(document.getElementById('pcAvailableWarPoints').textContent);

            if (totalCost > availableWarPoints) {
                alert(`æˆ¦å‹ç‚¹ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚è¦æ±‚ç·ã‚³ã‚¹ãƒˆ: ${totalCost}, åˆ©ç”¨å¯èƒ½æˆ¦å‹ç‚¹: ${availableWarPoints}`);
                return;
            }

            if (!confirm(`åˆè¨ˆ${totalCost}æˆ¦å‹ç‚¹ã‚’æ¶ˆè²»ã—ã¦ã€ã“ã‚Œã‚‰ã®è¦æ±‚ã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ`)) { return; }

            const demands = {
                money: parseInt(document.getElementById('pcMoney').value) || 0,
                oil: parseInt(document.getElementById('pcOil').value) || 0,
                iron: parseInt(document.getElementById('pcIron').value) || 0,
                infantry: parseInt(document.getElementById('pcInfantry').value) || 0,
                tank: parseInt(document.getElementById('pcTank').value) || 0,
                mechanizedInfantry: parseInt(document.getElementById('pcMechanizedInfantry').value) || 0,
                artillery: parseInt(document.getElementById('pcArtillery').value) || 0,
                bomber: parseInt(document.getElementById('pcBomber').value) || 0,
                missile: parseInt(document.getElementById('pcMissile').value) || 0,
                nuclearMissile: parseInt(document.getElementById('pcNuclearMissile').value) || 0,
                territories: Array.from(document.getElementById('peaceDemandsTerritories').selectedOptions).map(option => option.value)
            };

            try {
                const result = await fetchData('/api/makePeaceDemands', 'POST', { warId, demands });
                alert(result.message);
                if (result.success) { closePeaceConferenceModal(); }
            } catch (error) { alert(error.message); }
        }

        // --- NEW: National Focus JavaScript Functions ---
        async function loadNationalFocusStatus() {
            try {
                const result = await fetchData('/api/getAvailableNationalFocuses');
                const currentStatusDiv = document.getElementById('currentFocusStatus');
                const focusNameSpan = document.getElementById('focusName');
                const focusDescriptionSpan = document.getElementById('focusDescription');
                const focusProgressP = document.getElementById('focusProgress');
                const focusTurnsRemainingSpan = document.getElementById('focusTurnsRemaining');
                const availableFocusesList = document.getElementById('availableFocuses');
                const resetFocusBtn = document.getElementById('resetFocusBtn');

                if (!result.success && !result.activeFocus) { // activeFocusãŒãªã„å ´åˆã‚‚ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                    currentStatusDiv.className = 'no-focus';
                    focusNameSpan.textContent = 'ã‚¨ãƒ©ãƒ¼';
                    focusDescriptionSpan.textContent = result.message;
                    focusProgressP.style.display = 'none';
                    availableFocusesList.innerHTML = `<li>${result.message}</li>`;
                    resetFocusBtn.style.display = 'none';
                    return;
                }

                if (result.activeFocus) {
                    currentStatusDiv.className = '';
                    focusNameSpan.textContent = result.activeFocus.name;
                    focusDescriptionSpan.textContent = result.activeFocus.description;
                    focusProgressP.style.display = 'block';

                    const myNation = nations.find(n => n.owner === currentUserIp);
                    if (myNation) {
                        focusTurnsRemainingSpan.textContent = myNation.focusTurnsRemaining;
                    } else {
                        focusTurnsRemainingSpan.textContent = 'N/A';
                    }
                    resetFocusBtn.style.display = 'inline-block';
                } else {
                    currentStatusDiv.className = 'no-focus';
                    focusNameSpan.textContent = 'ãªã—';
                    focusDescriptionSpan.textContent = 'å›½å®¶æ–¹é‡ã‚’é¸æŠã—ã¦ã€å›½ã‚’å¼·åŒ–ã—ã¾ã—ã‚‡ã†ã€‚';
                    focusProgressP.style.display = 'none';
                    resetFocusBtn.style.display = 'none';
                }

                availableFocusesList.innerHTML = '';
                if (result.focuses && result.focuses.length > 0) {
                    result.focuses.forEach(focus => {
                        const li = document.createElement('li');
                        li.className = 'focus-item';
                        let effectsText = '';
                        for (const effectKey in focus.effects) {
                            const value = focus.effects[effectKey];
                            if (effectKey === 'ironProductionBonus') effectsText += `é‰„ç”Ÿç”£+${value * 100}%, `;
                            else if (effectKey === 'oilProductionBonus') effectsText += `çŸ³æ²¹ç”Ÿç”£+${value * 100}%, `;
                            else if (effectKey === 'moneyProductionBonus') effectsText += `ãŠé‡‘ç”Ÿç”£+${value * 100}%, `;
                            else if (effectKey === 'infantryPowerBonus') effectsText += `æ­©å…µæˆ¦é—˜åŠ›+${value}, `;
                            else if (effectKey === 'tankPowerBonus') effectsText += `æˆ¦è»Šæˆ¦é—˜åŠ›+${value}, `;
                            else if (effectKey === 'mechanizedInfantryPowerBonus') effectsText += `æ©Ÿæ¢°åŒ–æ­©å…µæˆ¦é—˜åŠ›+${value}, `;
                            else if (effectKey === 'populationGrowthBonus') effectsText += `äººå£å¢—åŠ ç‡+${(value * 100).toFixed(2)}%, `;
                            else if (effectKey === 'missileCostReduction') effectsText += `ãƒŸã‚µã‚¤ãƒ«ã‚³ã‚¹ãƒˆ-${value * 100}%, `;
                            else if (effectKey === 'bomberCostReduction') effectsText += `çˆ†æ’ƒæ©Ÿã‚³ã‚¹ãƒˆ-${value * 100}%, `;
                            else if (effectKey === 'defenseBonusIncrease') effectsText += `é˜²è¡›ãƒœãƒ¼ãƒŠã‚¹+${(value * 100).toFixed(2)}%, `;
                        }
                        effectsText = effectsText.slice(0, -2);

                        let prerequisitesText = '';
                        if (focus.prerequisites && focus.prerequisites.length > 0) {
                            const prereqNames = focus.prerequisites.map(id => nationalFocusDefinitionsClient[id] ? nationalFocusDefinitionsClient[id].name : id).join(', ');
                            prerequisitesText = `<p><strong>å‰ææ¡ä»¶:</strong> ${prereqNames}</p>`;
                        }

                        let exclusiveWithText = '';
                        if (focus.exclusiveWith && focus.exclusiveWith.length > 0) {
                            const exclusiveNames = focus.exclusiveWith.map(id => nationalFocusDefinitionsClient[id] ? nationalFocusDefinitionsClient[id].name : id).join(', ');
                            exclusiveWithText = `<p><strong>æ’ä»–æ–¹é‡:</strong> ${exclusiveNames}</p>`;
                        }

                        li.innerHTML = `
                            <h4>${focus.name}</h4>
                            <p>${focus.description}</p>
                            <p class="cost">æ‰€è¦ã‚¿ãƒ¼ãƒ³: ${focus.costTurns}ã‚¿ãƒ¼ãƒ³</p>
                            <p><strong>åŠ¹æœ:</strong> ${effectsText}</p>
                            ${prerequisitesText}
                            ${exclusiveWithText}
                            <button onclick="startFocus('${focus.id}')">é–‹å§‹</button>
                        `;
                        availableFocusesList.appendChild(li);
                    });
                } else if (!result.activeFocus) {
                    availableFocusesList.innerHTML = '<li>ç¾åœ¨ã€åˆ©ç”¨å¯èƒ½ãªå›½å®¶æ–¹é‡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
                }
            } catch (error) { console.error('å›½å®¶æ–¹é‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error); }
        }

        async function startFocus(focusId) {
            if (confirm('å›½å®¶æ–¹é‡ã€Œ' + focusId + 'ã€ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ')) {
                try {
                    const result = await fetchData('/api/startNationalFocus', 'POST', { focusId });
                    alert(result.message);
                    if (result.success) {
                        loadNationalFocusStatus();
                        loadNations();
                    }
                } catch (error) { alert(error.message); }
            }
        }

        async function resetFocus() {
            if (confirm('å›½å®¶æ–¹é‡ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ (å®Œäº†ã—ãŸæ–¹é‡ã‚‚ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™)')) {
                try {
                    const result = await fetchData('/api/resetNationalFocus', 'POST');
                    alert(result.message);
                    if (result.success) {
                        loadNationalFocusStatus();
                        loadNations();
                    }
                } catch (error) { alert(error.message); }
            }
        }

        // --- Title Management Functions (Client-side) ---
        async function loadTitleDefinitions() {
            try {
                titleDefinitions = await fetchData('/api/titleDefinitions');
            } catch (error) { console.error('ç§°å·å®šç¾©ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error); }
        }

        async function loadUserTitlesManagement() {
            try {
                const data = await fetchData('/api/getUserTitlesData');
                const currentDisplayTitleSpan = document.getElementById('currentDisplayTitle');
                const acquiredTitlesSelect = document.getElementById('acquiredTitlesSelect');

                acquiredTitlesSelect.innerHTML = '';

                if (data.acquiredTitles.length === 0) {
                    acquiredTitlesSelect.innerHTML = '<option value="">ç§°å·ã‚’æ‰€æœ‰ã—ã¦ã„ã¾ã›ã‚“</option>';
                    currentDisplayTitleSpan.textContent = 'ãªã—';
                    return;
                }

                let currentTitleName = 'ãªã—';
                if (data.selectedTitleId && titleDefinitions[data.selectedTitleId]) {
                    currentTitleName = titleDefinitions[data.selectedTitleId].name;
                }
                currentDisplayTitleSpan.textContent = currentTitleName;

                data.acquiredTitles.forEach(titleId => {
                    if (titleDefinitions[titleId]) {
                        const option = document.createElement('option');
                        option.value = titleId;
                        option.textContent = titleDefinitions[titleId].name;
                        if (titleId === data.selectedTitleId) {
                            option.selected = true;
                        }
                        acquiredTitlesSelect.appendChild(option);
                    }
                });
            } catch (error) { console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç§°å·æƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error); }
        }

        async function selectDisplayTitle() {
            const selectedTitleId = document.getElementById('acquiredTitlesSelect').value;
            if (!selectedTitleId) { alert("è¡¨ç¤ºã™ã‚‹ç§°å·ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
            try {
                const result = await fetchData('/api/selectDisplayTitle', 'POST', { titleId: selectedTitleId });
                alert(result.message);
                if (result.success) {
                    loadUserTitlesManagement();
                    loadNations();
                }
            } catch (error) { alert(error.message); }
        }

        async function grantTestTitle() {
            const titleIdToGrant = prompt("ä»˜ä¸ã™ã‚‹ç§°å·ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: emperor, warlord):");
            if (titleIdToGrant) {
                try {
                    const result = await fetchData('/api/grantTitleToUser', 'POST', { targetUserIp: currentUserIp, titleId: titleIdToGrant });
                    alert(result.message);
                    if (result.success) {
                        loadUserTitlesManagement();
                        loadNations();
                    }
                } catch (error) { alert(error.message); }
            }
        }

        // ==========================================================
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–ã¨å®šæœŸå®Ÿè¡Œ
        // ==========================================================
        window.onload = async () => {
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼IPã®å–å¾—
                const ipData = await fetchData('/api/user/ip');
                currentUserIp = ipData.ip;
                console.log('Current User IP:', currentUserIp);

                // ã‚²ãƒ¼ãƒ å®šæ•°ã®ãƒ­ãƒ¼ãƒ‰
                gameConstants = await fetchData('/api/gameConstants');
                updateCostDisplays(); // ã‚³ã‚¹ãƒˆè¡¨ç¤ºã®æ›´æ–°ã‚’æœ€åˆã«1å›å®Ÿè¡Œ

                // å›½å®¶æ–¹é‡ã¨ç§°å·å®šç¾©ã®ãƒ­ãƒ¼ãƒ‰
                nationalFocusDefinitionsClient = await fetchData('/api/getAvailableNationalFocuses');
                await loadTitleDefinitions(); // ç§°å·å®šç¾©ãŒloadNationsã‚ˆã‚Šå…ˆã«å¿…è¦

                // ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã«ä»–ã®ãƒ­ãƒ¼ãƒ‰é–¢æ•°ã‚’å®Ÿè¡Œ
                loadNations(); // ã“ã‚ŒãŒGeoJSONã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãªã©ã‚’ãƒˆãƒªã‚¬ãƒ¼
                loadChatMessages();
                loadAlliances();
                loadFlightRequests();
                loadEstablishedFlights();
                loadNationalFocusStatus();
                loadTerritoryRanking();
                loadWars();
                loadUserTitlesManagement();



                // å®šæœŸå®Ÿè¡Œ (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã®ç”»é¢æ›´æ–°ç”¨)
                setInterval(loadNations, 7000);
                setInterval(loadChatMessages, 5000);
                setInterval(loadAlliances, 10000);
                setInterval(loadFlightRequests, 10000);
                setInterval(loadEstablishedFlights, 10000);
                setInterval(loadOnlineUsers, 15000);
                setInterval(loadNationalFocusStatus, 7000);
                setInterval(loadTerritoryRanking, 10000);
                setInterval(loadUserTitlesManagement, 10000);

                // BGMå†ç”Ÿ
                const bgm = new Audio("https://www.mod.go.jp/gsdf/fan/sound/download/bunretsu_koshin.mp3");
                bgm.loop = true;
                // ãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒãªã„ã¨å†ç”Ÿã•ã‚Œãªã„å ´åˆãŒã‚ã‚‹ãŸã‚
                document.body.addEventListener("click", function() {
                    bgm.play().catch(e => console.log("BGMè‡ªå‹•å†ç”Ÿå¤±æ•—:", e));
                }, { once: true });

            } catch (error) {
                console.error('åˆæœŸãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                alert(`ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        };

    </script>
</body>
</html>